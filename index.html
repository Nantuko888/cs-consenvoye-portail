<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>CS Consenvoye</title>

<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
<link rel="manifest" href="manifest.json">

<meta name="theme-color" content="#d46a00">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
:root{
  --maxw: 760px;
  --titleMaxH: 34vh;
  --btn: clamp(100px, min(22vw, 15vh), 170px);
  --gap: clamp(10px, min(3vw, 2vh), 18px);
}
*{ box-sizing:border-box; }
html, body{
  margin:0; padding:0; height:100%;
  overflow:auto; overscroll-behavior-y:auto;
  background:#000;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  -webkit-text-size-adjust:100%;
}
body{
  background:#000 url("background.png") center top / cover no-repeat fixed;
}
.wrap{
  min-height:100vh;
  min-height:100dvh;
  width:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding-bottom: calc(env(safe-area-inset-bottom) + 12px);
}
.title{
  margin-top: calc(env(safe-area-inset-top) + 2px);
  width: min(94vw, 680px);
  max-height: var(--titleMaxH);
  height:auto;
  object-fit:contain;
  display:block;
  pointer-events:none;
  user-select:none;
  transform: scale(1.25);
  transform-origin: center top;
}
.grid{
  width: min(94vw, var(--maxw));
  margin-top: clamp(8px, 1.5vh, 16px);
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--gap);
  justify-items:center;
  align-content:start;
}
.btn{
  width: var(--btn);
  height: var(--btn);
  display:block;
  text-decoration:none;
  -webkit-tap-highlight-color:transparent;
}
.btn img{
  width:100%;
  height:100%;
  object-fit:contain;
  display:block;
}

/* Login box */
#loginBox{
  min-height:100vh;
  min-height:100dvh;
  width:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  gap:14px;
  padding:24px;
  background:rgba(0,0,0,.35);
  backdrop-filter: blur(2px);
}
#loginTitle{
  color:#fff;
  font-weight:700;
  text-align:center;
  text-shadow:0 2px 10px rgba(0,0,0,.7);
  line-height:1.2;
}
#loginSub{
  color:#ddd;
  font-size:14px;
  text-align:center;
  max-width:520px;
}
#status{
  color:#ffd;
  font-size:13px;
  opacity:.9;
}

@media (min-width:768px){
  :root{
    --btn: clamp(110px, 16vw, 180px);
    --titleMaxH: 26vh;
    --maxw:900px;
  }
}
</style>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox" style="display:none;">
  <div id="loginTitle">Connexion Google requise</div>
  <div id="loginSub">Accès réservé aux agents autorisés.</div>

  <!-- GIS config -->
  <div id="g_id_onload"
       data-client_id="690765229829-9bbdccrsm9dd8c1sj01k06bqsdna3hgs.apps.googleusercontent.com"
       data-callback="handleCredentialResponse"
       data-auto_prompt="false">
  </div>

  <div class="g_id_signin"
       data-type="standard"
       data-size="large"
       data-theme="outline"
       data-text="sign_in_with"
       data-shape="rectangular">
  </div>

  <div id="status"></div>
</div>

<!-- PORTAIL -->
<main id="portal" class="wrap" style="display:none;">

  <img class="title" src="titre.png" alt="Bienvenue sur CS Consenvoye">

  <section class="grid">

    <a class="btn" href="https://nantuko888.github.io/Entretien-CS-Consenvoye-/">
      <img src="entretien.png" alt="Entretien">
    </a>

    <a class="btn" href="documents.html">
      <img src="documents.png" alt="Documents">
    </a>

    <a class="btn" href="organigramme.html">
      <img src="organigramme.png" alt="Organigramme">
    </a>

    <a class="btn" href="construction.png">
      <img src="informations.png" alt="Informations">
    </a>

    <a class="btn" href="planning.html">
      <img src="planning.png" alt="Planning">
    </a>

    <a class="btn" href="equipes.html">
      <img src="equipes.png" alt="Équipes">
    </a>

    <a class="btn" href="construction.png">
      <img src="book.png" alt="Book">
    </a>

    <a class="btn" href="construction.png">
      <img src="galerie.png" alt="Galerie">
    </a>

    <a class="btn" href="construction.png">
      <img src="admin.png" alt="Admin">
    </a>

    <a class="btn" href="construction.png">
      <img src="gardes postées.png" alt="Gardes postées">
    </a>

    <a class="btn" href="construction.png">
      <img src="tickets carburant.png" alt="Tickets carburant">
    </a>

    <a class="btn" href="construction.png">
      <img src="désinfection VSAV.png" alt="Désinfection VSAV">
    </a>

  </section>
</main>

<script>
/* ================== CONFIG ================== */
const API_BASE = "https://script.google.com/macros/s/AKfycbzPHCDdW7wkFCVkMOL_2srZmdnjZ1QKmToUFtqIZBPjSUNtOwM-Ac7ua0w9dhCv3oI/exec";
const AUTH_KEY = "cs_auth_email";

/* ================== UI ================== */
const $login = () => document.getElementById("loginBox");
const $portal = () => document.getElementById("portal");
const $status = () => document.getElementById("status");

function setStatus(msg){
  if ($status()) $status().textContent = msg || "";
}
function showLogin(msg){
  $portal().style.display = "none";
  $login().style.display = "flex";
  setStatus(msg || "");
}
function showPortal(){
  $login().style.display = "none";
  $portal().style.display = "flex";
  setStatus("");
}

/* ================== STORAGE ================== */
function saveAuth(email){
  localStorage.setItem(AUTH_KEY, String(email || "").toLowerCase());
}
function loadAuth(){
  return (localStorage.getItem(AUTH_KEY) || "").toLowerCase();
}
function clearAuth(){
  localStorage.removeItem(AUTH_KEY);
}

/* ================== JSONP PARSER (Apps Script renvoie callback(...)) ================== */
function parseCallbackText(txt){
  // txt = callback({...});
  const cleaned = String(txt || "").replace(/^callback\(/, "").replace(/\);\s*$/, "");
  return JSON.parse(cleaned);
}

/* ================== AUTH CHECK (anti-boucle) ================== */
let checking = false;

function authCheck(email){
  const e = encodeURIComponent(email || "");
  // IMPORTANT : on passe bien ?email=
  const url = `${API_BASE}?view=auth_check&email=${e}&callback=callback&nocache=1`;

  // on lit en text puis parse callback(...)
  return fetch(url, { cache: "no-store" })
    .then(r => r.text())
    .then(parseCallbackText);
}

/* ================== GOOGLE SIGN-IN CALLBACK ================== */
function handleCredentialResponse(response){
  try{
    if(!response || !response.credential){
      showLogin("Erreur: pas de jeton Google.");
      return;
    }

    // Décodage JWT (payload)
    const payload = response.credential.split(".")[1]
      .replace(/-/g, "+")
      .replace(/_/g, "/");
    const json = JSON.parse(decodeURIComponent(escape(atob(payload))));
    const email = (json.email || "").toLowerCase();

    if(!email){
      showLogin("Impossible de lire l'email Google.");
      return;
    }

    setStatus("Vérification de l'accès…");

    authCheck(email).then(res => {
      if(res && res.ok){
        saveAuth(email); // reste connecté illimité (sur l’appareil)
        showPortal();
      }else{
        clearAuth();
        showLogin("Accès refusé.");
      }
    }).catch(err => {
      console.error(err);
      showLogin("Erreur de connexion (API).");
    });

  }catch(e){
    console.error(e);
    showLogin("Erreur de traitement.");
  }
}

/* ================== BOOT ================== */
window.addEventListener("load", () => {
  const saved = loadAuth();

  if(!saved){
    // pas d'email sauvegardé -> login
    showLogin("");
    return;
  }

  // email sauvegardé -> revalide une seule fois (anti-boucle)
  if(checking) return;
  checking = true;

  showLogin("Vérification en cours…");

  authCheck(saved).then(res => {
    checking = false;
    if(res && res.ok){
      showPortal();
    }else{
      clearAuth();
      showLogin("Accès refusé.");
    }
  }).catch(err => {
    checking = false;
    console.error(err);
    // si API KO, on revient au login (pas de boucle)
    showLogin("Erreur de connexion (API).");
  });
});
</script>

</body>
</html>
