<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Désinfection VSAV — CS Consenvoye</title>

<style>
:root{
  --bg:#000;
  --txt:#fff;
  --muted:rgba(255,255,255,.75);

  --orange:#d46a00;
  --orange2:#b95800;

  --card: rgba(0,0,0,.50);
  --stroke: rgba(255,255,255,.12);

  --greenHead:#79b84e; /* bandeau MOIS/REFERENT/AGENT/DATE */
  --yellowTitle:#fff200; /* titre */
  --monthA:#bcd5ee; /* alternance mois */
  --monthB:#ffe39c;

  --shadow: 0 14px 34px rgba(0,0,0,.40);
  --radius: 18px;

  /* ✅ hauteur réelle écran (Samsung/Android) */
  --appH: 100dvh;
}

*{box-sizing:border-box}
html,body{height:100%}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background: var(--bg);
  color: var(--txt);
  overflow:hidden; /* ✅ jamais de scrollbar */
  overscroll-behavior:none; /* ✅ pas de bounce */

  /* ✅ FIX ANDROID : on force la vraie hauteur */
  height: var(--appH);
}

/* fond portail */
.bg{
  position:fixed; inset:0;
  background:
    linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.55)),
    url("background.png") center top/cover no-repeat;
  z-index:-2;
}
.bg::after{
  content:"";
  position:absolute; inset:0;
  background: radial-gradient(circle at 50% 10%, rgba(255,170,60,.16), rgba(0,0,0,.72) 62%);
  z-index:-1;
}

/* page layout */
.wrap{
  /* ✅ FIX ANDROID : même hauteur que body */
  height: var(--appH);

  width:min(980px, 100%);
  margin:0 auto;
  padding:
    calc(env(safe-area-inset-top) + 10px)
    12px
    calc(env(safe-area-inset-bottom) + 12px);
  display:grid;
  grid-template-rows: auto auto 1fr; /* topbar / tabs / content */
  gap: 10px;
  overflow:hidden; /* ✅ */
  min-height:0; /* ✅ */
}

/* topbar */
.topbar{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding: 10px 12px;
  border-radius: var(--radius);
  background: linear-gradient(180deg, rgba(212,106,0,.75), rgba(185,88,0,.55));
  border: 1px solid rgba(255,255,255,.12);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  min-height: 46px;
}
.topbar .title{
  margin:0;
  font-weight:950;
  letter-spacing:.6px;
  text-transform: uppercase;
  font-size: clamp(15px, 2.2vw, 18px);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.btn{
  border:1px solid rgba(255,255,255,.18);
  background: rgba(0,0,0,.18);
  color:var(--txt);
  padding: 9px 12px;
  border-radius: 14px;
  font-weight:900;
  cursor:pointer;
  -webkit-tap-highlight-color: transparent;
  white-space:nowrap;
}
.btn:active{transform: translateY(1px)}

/* tabs */
.tabs{
  display:flex; gap:10px;
}
.tab{
  flex:1;
  padding: 10px 12px;
  border-radius: var(--radius);
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.28);
  box-shadow: var(--shadow);
  font-weight:950;
  letter-spacing:.3px;
  cursor:pointer;
  color: rgba(255,255,255,.86);
  -webkit-tap-highlight-color: transparent;
}
.tab.active{
  background: linear-gradient(180deg, rgba(212,106,0,.62), rgba(185,88,0,.45));
  color: #fff;
  border-color: rgba(255,255,255,.16);
}
.tab:active{transform: translateY(1px)}

/* content card */
.card{
  border-radius: 22px;
  background: linear-gradient(180deg, rgba(0,0,0,.52), rgba(0,0,0,.32));
  border:1px solid rgba(255,255,255,.12);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  overflow:hidden; /* ✅ */
  min-height:0; /* ✅ important pour grid */
  display:flex;
  flex-direction:column;
}

/* title banner */
.banner{
  background: var(--yellowTitle);
  color:#000;
  font-weight: 950;
  text-align:center;
  padding: 10px 10px;
  border-bottom: 2px solid rgba(0,0,0,.25);
  letter-spacing:.8px;
  font-size: clamp(16px, 2.6vw, 22px);
}

/* table grid (1 header + 12 rows) */
.table{
  flex:1;
  display:grid;
  grid-template-rows: auto 1fr; /* header + body */
  min-height:0;
}

/* header row */
.thead{
  display:grid;
  grid-template-columns: 1.05fr 1fr 1fr .85fr;
  gap:0;
  background: var(--greenHead);
  color:#0a0a0a;
  font-weight:950;
  text-transform:uppercase;
  letter-spacing:.6px;
  border-bottom: 2px solid rgba(0,0,0,.25);
}
.th{
  padding: 10px 10px;
  text-align:center;
  border-right: 2px solid rgba(0,0,0,.25);
  font-size: clamp(12px, 1.9vw, 14px);
}
.th:last-child{border-right:none;}

/* body rows fill height => pas de scroll */
.tbody{
  display:grid;
  grid-template-rows: repeat(12, 1fr); /* ✅ 12 mois = prend toute la hauteur restante */
  min-height:0;
}
.tr{
  display:grid;
  grid-template-columns: 1.05fr 1fr 1fr .85fr;
  border-bottom: 2px solid rgba(255,255,255,.12);
}
.tr:last-child{border-bottom:none;}

.td{
  display:flex;
  align-items:center;
  justify-content:center;
  padding: 6px 8px;
  text-align:center;
  border-right: 2px solid rgba(255,255,255,.12);
  min-width:0;
  font-weight: 850;
  font-size: clamp(11px, 1.75vw, 14px);
  color: rgba(255,255,255,.92);
}
.td:last-child{border-right:none;}

.month{
  color:#111;
  font-weight: 950;
  letter-spacing:.6px;
  text-transform:uppercase;
}
.month.a{ background: var(--monthA); }
.month.b{ background: var(--monthB); }

.ref, .agent, .date{
  background: rgba(0,0,0,.10);
}

/* petit style “dropdown” visuel (sans logique pour l’instant) */
.agent .fakeSelect{
  width:100%;
  max-width: 220px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding: 7px 10px;
  border-radius: 12px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.20);
  color: rgba(255,255,255,.92);
  overflow:hidden;
}
.agent .fakeSelect span{
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.agent .fakeSelect i{
  font-style:normal;
  opacity:.9;
}

/* inventaire placeholder */
.inv{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  padding: 14px;
  text-align:center;
  color: rgba(255,255,255,.86);
  font-weight:900;
  font-size: clamp(14px, 2.2vw, 18px);
}
  .agentBtn{
  width:100%;
  max-width: 220px;
  padding: 8px 10px;
  border-radius: 12px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(0,0,0,.20);
  color: rgba(255,255,255,.95);
  font-weight: 900;
  cursor:pointer;
}
.agentBtn.locked{ opacity:.55; cursor:not-allowed; }
.agentBtn.mine{ background: rgba(212,106,0,.45); border-color: rgba(255,255,255,.22); }

/* petites sécurités écrans très petits */
@media (max-width:360px){
  .th{padding:8px 6px}
  .td{padding:5px 6px}
  .agent .fakeSelect{padding:6px 8px}
}
</style>
</head>

<body>
<div class="bg"></div>

<div class="wrap">

  <div class="topbar">
    <h1 class="title">Désinfection VSAV</h1>
    <button class="btn" id="btnBack">Retour</button>
  </div>

  <div class="tabs" role="tablist" aria-label="Désinfection VSAV onglets">
    <button class="tab active" id="tabInscription" role="tab" aria-selected="true">Inscription</button>
    <button class="tab" id="tabInventaire" role="tab" aria-selected="false">Inventaire</button>
  </div>

  <section class="card" id="panelInscription" role="tabpanel" aria-labelledby="tabInscription">
    <div class="banner">DESINFECTION VSAV 2026</div>

    <div class="table">
      <div class="thead">
        <div class="th">MOIS</div>
        <div class="th">REFERENT</div>
        <div class="th">AGENT</div>
        <div class="th">DATE</div>
      </div>

      <div class="tbody" id="tbody">
        <!-- ✅ 12 lignes fixes (on ne met pas les noms ici) -->
        <div class="tr">
          <div class="td month a">JANVIER</div>
          <div class="td ref">—</div>
          <div class="td agent">
  <button class="agentBtn" data-month="JANVIER">S’inscrire</button>
</div>
          <div class="td date">—</div>
        </div>
        <div class="tr">
          <div class="td month b">FÉVRIER</div>
          <div class="td ref">—</div>
          <div class="td agent">
  <button class="agentBtn" data-month="FÉVRIER">S’inscrire</button>
</div>
          <div class="td date">—</div>
        </div>
        <div class="tr">
          <div class="td month a">MARS</div>
          <div class="td ref">—</div>
          <div class="td agent">
  <button class="agentBtn" data-month="MARS">S’inscrire</button>
</div>
          <div class="td date">—</div>
        </div>
        <div class="tr">
          <div class="td month b">AVRIL</div>
          <div class="td ref">—</div>
          <div class="td agent">
  <button class="agentBtn" data-month="AVRIL">S’inscrire</button>
</div>
          <div class="td date">—</div>
        </div>
        <div class="tr">
          <div class="td month a">MAI</div>
          <div class="td ref">—</div>
          <div class="td agent">
  <button class="agentBtn" data-month="MAI">S’inscrire</button>
</div>
          <div class="td date">—</div>
        </div>
        <div class="tr">
          <div class="td month b">JUIN</div>
          <div class="td ref">—</div>
          <div class="td agent">
  <button class="agentBtn" data-month="JUIN">S’inscrire</button>
</div>
          <div class="td date">—</div>
        </div>
        <div class="tr">
          <div class="td month a">JUILLET</div>
          <div class="td ref">—</div>
          <div class="td agent">
  <button class="agentBtn" data-month="JUILLET">S’inscrire</button>
</div>
          <div class="td date">—</div>
        </div>
        <div class="tr">
          <div class="td month b">AOÛT</div>
          <div class="td ref">—</div>
          <div class="td agent">
  <button class="agentBtn" data-month="AOÛT">S’inscrire</button>
</div>
          <div class="td date">—</div>
        </div>
        <div class="tr">
          <div class="td month a">SEPTEMBRE</div>
          <div class="td ref">—</div>
          <div class="td agent">
  <button class="agentBtn" data-month="SEPTEMBRE">S’inscrire</button>
</div>
          <div class="td date">—</div>
        </div>
        <div class="tr">
          <div class="td month b">OCTOBRE</div>
          <div class="td ref">—</div>
          <div class="td agent">
  <button class="agentBtn" data-month="OCTOBRE">S’inscrire</button>
</div>
          <div class="td date">—</div>
        </div>
        <div class="tr">
          <div class="td month a">NOVEMBRE</div>
          <div class="td ref">—</div>
          <div class="td agent">
  <button class="agentBtn" data-month="NOVEMBRE">S’inscrire</button>
</div>
          <div class="td date">—</div>
        </div>
        <div class="tr">
          <div class="td month b">DÉCEMBRE</div>
          <div class="td ref">—</div>
          <div class="td agent">
  <button class="agentBtn" data-month="DÉCEMBRE">S’inscrire</button>
</div>
          <div class="td date">—</div>
        </div>
      </div>
    </div>
  </section>

  <section class="card" id="panelInventaire" role="tabpanel" aria-labelledby="tabInventaire" style="display:none;">
    <div class="banner">INVENTAIRE VSAV</div>
    <div class="inv">
      (Structure inventaire à ajouter ici — pour l’instant c’est le placeholder)
    </div>
  </section>

</div>

<script>
/* ✅ FIX ANDROID / SAMSUNG : vraie hauteur sans barre système qui bouffe le bas */
function setAppHeight(){
  document.documentElement.style.setProperty("--appH", window.innerHeight + "px");
}
window.addEventListener("resize", setAppHeight);
window.addEventListener("orientationchange", setAppHeight);
setAppHeight();

/* ✅ Retour */
document.getElementById("btnBack").addEventListener("click", ()=>{
  // adapte si tu veux renvoyer ailleurs
  location.href = "/cs-consenvoye-portail/index.html?portal=1";
});

/* ✅ Tabs (juste affichage) */
const tabIns = document.getElementById("tabInscription");
const tabInv = document.getElementById("tabInventaire");
const panIns = document.getElementById("panelInscription");
const panInv = document.getElementById("panelInventaire");

function setTab(which){
  const ins = (which==="ins");
  tabIns.classList.toggle("active", ins);
  tabInv.classList.toggle("active", !ins);
  tabIns.setAttribute("aria-selected", ins ? "true" : "false");
  tabInv.setAttribute("aria-selected", ins ? "false" : "true");
  panIns.style.display = ins ? "flex" : "none";
  panInv.style.display = ins ? "none" : "flex";
}
tabIns.addEventListener("click", ()=>setTab("ins"));
tabInv.addEventListener("click", ()=>setTab("inv"));
  
/* =======================
   VSAV — CHARGEMENT API
   ======================= */
const API = "https://script.google.com/macros/s/AKfycbzPHCDdW7wkFCVkMOL_2srZmdnjZ1QKmToUFtqIZBPjSUNtOwM-Ac7ua0w9dhCv3oI/exec"; // <-- URL /exec Apps Script

function jsonp(url, cbName, timeoutMs=12000){
  return new Promise((resolve, reject)=>{
    const s = document.createElement("script");
    const cleanup = ()=>{
      s.remove();
      try{ delete window[cbName]; }catch(e){ window[cbName]=undefined; }
    };
    const t = setTimeout(()=>{ cleanup(); reject(new Error("Timeout JSONP")); }, timeoutMs);
    window[cbName] = (data)=>{ clearTimeout(t); cleanup(); resolve(data); };
    s.src = url + (url.includes("?") ? "&" : "?") + "_t=" + Date.now();
    s.onerror = ()=>{ clearTimeout(t); cleanup(); reject(new Error("Erreur JSONP")); };
    document.head.appendChild(s);
  });
}
  function authEmail(){
  const email = localStorage.getItem("cs_portail_email_v1");
  console.log("EMAIL DETECTE:", email);
  return (email || "").trim().toLowerCase();
}

function parseSignedAgent(s){
  s = (s||"").toString().trim();
  if(!s) return { name:"", email:"" };
  if(!s.includes("|")) return { name:s, email:"" };
  const [name, email] = s.split("|").map(x=>x.trim());
  return { name, email:(email||"").toLowerCase() };
}

function setButtonsState(rows, myEmail){
  const tbody = document.getElementById("tbody");
  for(let i=0;i<12;i++){
    const tr = tbody.children[i];
    if(!tr) continue;

    // rows peut être array d’objets OU array d’arrays -> on gère les 2
    const r = rows[i] || {};
    const mois = (r.mois ?? r[0] ?? "").toString().trim().toUpperCase();
    const agentRaw = (r.agent ?? r[2] ?? "").toString().trim();

    const btn = tr.querySelector(".agentBtn");
    if(!btn) continue;
    if(mois) btn.dataset.month = mois;

    const a = parseSignedAgent(agentRaw);

    // Vide => inscription possible
    if(!agentRaw){
      btn.textContent = "S’inscrire";
      btn.classList.remove("locked","mine");
      btn.disabled = false;
      continue;
    }

    // A moi => annulation possible
    if(a.email && myEmail && a.email === myEmail){
      btn.textContent = "Annuler";
      btn.classList.remove("locked");
      btn.classList.add("mine");
      btn.disabled = false;
      continue;
    }

    // Déjà pris => bloqué
    btn.textContent = "Pris";
    btn.classList.add("locked");
    btn.classList.remove("mine");
    btn.disabled = true;
  }
}


async function loadVsav(){
  const cb = "cb_vsav_" + Math.random().toString(36).slice(2);
  const url = `${API}?view=vsav_get&nocache=1&callback=${cb}`;
  return await jsonp(url, cb, 15000);
}

function fillVsavTable(rows){
  const tbody = document.getElementById("tbody");
  if(!tbody) return;

  for(let i=0; i<12; i++){
    const tr = tbody.children[i];
    if(!tr) continue;

    const r = rows && rows[i] ? rows[i] : {};
    const referent = (r.referent ?? r[1] ?? "").toString().trim();
    const dateVal = (r.date_validation ?? r[3] ?? "").toString().trim();

    tr.children[1].textContent = referent || "—";
    tr.children[3].textContent = dateVal || "—";
  }
}

/* BOOT */
(async function(){
  try{
    const myEmail = await authEmail();
    const res = await loadVsav();
    if(res && res.ok){
      fillVsavTable(res.rows || []);
      setButtonsState(res.rows || [], myEmail);
    }

    document.querySelectorAll(".agentBtn").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const month = btn.dataset.month;
        const myEmail2 = await authEmail();
        if(!myEmail2){ alert("Email non détecté"); return; }

        const action = (btn.textContent === "Annuler") ? "vsav_unset_agent" : "vsav_set_agent";
        const cb = "cb_act_" + Math.random().toString(36).slice(2);
        const url = `${API}?view=${action}&month=${encodeURIComponent(month)}&email=${encodeURIComponent(myEmail2)}&callback=${cb}&nocache=1`;

        try{
          const r = await jsonp(url, cb, 15000);
          if(!r?.ok){
            alert(r?.error || "Erreur");
            return;
          }
          // refresh
          const res2 = await loadVsav();
          if(res2?.ok){
            fillVsavTable(res2.rows || []);
            setButtonsState(res2.rows || [], myEmail2);
          }
        }catch(e){
          alert("Erreur réseau");
        }
      });
    });

  }catch(e){
    // silence
  }
})();

</script>
</body>
</html>
