<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Désinfection VSAV 2026 — CS Consenvoye</title>

<style>
:root{
  --bg:#000;
  --txt:#fff;

  --orange:#d46a00;
  --orange2:#b95800;

  --card: rgba(0,0,0,.50);
  --stroke: rgba(255,255,255,.12);

  --headGray:#d6d6d6;      /* ✅ entêtes gris clair */
  --monthA:#bcd5ee;
  --monthB:#ffe39c;

  --shadow: 0 14px 34px rgba(0,0,0,.40);
  --radius: 18px;

  --okGreen: rgba(50, 190, 90, .65);
  --badRed: rgba(210, 60, 60, .65);

  --appH: 100dvh;
}

*{box-sizing:border-box}
html,body{height:100%}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background: var(--bg);
  color: var(--txt);
  overflow:hidden;
  overscroll-behavior:none;
  height: var(--appH);
}

.bg{
  position:fixed; inset:0;
  background:
    linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.55)),
    url("background.png") center top/cover no-repeat;
  z-index:-2;
}
.bg::after{
  content:"";
  position:absolute; inset:0;
  background: radial-gradient(circle at 50% 10%, rgba(255,170,60,.16), rgba(0,0,0,.72) 62%);
  z-index:-1;
}

.wrap{
  height: var(--appH);
  width:min(1100px, 100%);
  margin:0 auto;
  padding:
    calc(env(safe-area-inset-top) + 10px)
    10px
    calc(env(safe-area-inset-bottom) + 12px);
  display:grid;
  grid-template-rows: auto auto 1fr;
  gap: 10px;
  overflow:hidden;
  min-height:0;
}

.topbar{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding: 10px 12px;
  border-radius: var(--radius);
  background: linear-gradient(180deg, rgba(212,106,0,.75), rgba(185,88,0,.55));
  border: 1px solid rgba(255,255,255,.12);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  min-height: 46px;
}
.topbar .title{
  margin:0;
  font-weight:950;
  letter-spacing:.6px;
  text-transform: uppercase;
  font-size: clamp(15px, 2.2vw, 18px);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.btn{
  border:1px solid rgba(255,255,255,.18);
  background: rgba(0,0,0,.18);
  color:var(--txt);
  padding: 9px 12px;
  border-radius: 14px;
  font-weight:900;
  cursor:pointer;
  -webkit-tap-highlight-color: transparent;
  white-space:nowrap;
}
.btn:active{transform: translateY(1px)}

.tabs{display:flex; gap:10px;}
.tab{
  flex:1;
  padding: 10px 12px;
  border-radius: var(--radius);
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.28);
  box-shadow: var(--shadow);
  font-weight:950;
  letter-spacing:.3px;
  cursor:pointer;
  color: rgba(255,255,255,.86);
  -webkit-tap-highlight-color: transparent;
}
.tab.active{
  background: linear-gradient(180deg, rgba(212,106,0,.62), rgba(185,88,0,.45));
  color: #fff;
  border-color: rgba(255,255,255,.16);
}
.tab:active{transform: translateY(1px)}

.card{
  border-radius: 22px;
  background: linear-gradient(180deg, rgba(0,0,0,.52), rgba(0,0,0,.32));
  border:1px solid rgba(255,255,255,.12);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  overflow:hidden;
  min-height:0;
  display:flex;
  flex-direction:column;
}

.banner{
  background: rgba(255,255,255,.10);
  color:#fff;
  font-weight: 950;
  text-align:center;
  padding: 10px 10px;
  border-bottom: 1px solid rgba(255,255,255,.12);
  letter-spacing:.8px;
  font-size: clamp(16px, 2.6vw, 22px);
  text-transform: uppercase;
}

.table{
  flex:1;
  display:grid;
  grid-template-rows: auto 1fr;
  min-height:0;
}

.thead{
  display:grid;
  grid-template-columns: 1.05fr 1fr 1fr .9fr 1.1fr; /* ✅ + justificatif */
  background: var(--headGray);
  color:#111;
  font-weight:950;
  text-transform:uppercase;
  letter-spacing:.6px;
  border-bottom: 2px solid rgba(0,0,0,.25);
}
.th{
  padding: 10px 8px;
  text-align:center;
  border-right: 2px solid rgba(0,0,0,.25);
  font-size: clamp(12px, 1.9vw, 14px);
}
.th:last-child{border-right:none;}

.tbody{
  display:grid;
  grid-template-rows: repeat(12, 1fr); /* ✅ 12 mois prennent toute la hauteur */
  min-height:0;
}
.tr{
  display:grid;
  grid-template-columns: 1.05fr 1fr 1fr .9fr 1.1fr;
  border-bottom: 2px solid rgba(255,255,255,.12);
}
.tr:last-child{border-bottom:none;}

.td{
  display:flex;
  align-items:center;
  justify-content:center;
  padding: 4px 6px;
  text-align:center;
  border-right: 2px solid rgba(255,255,255,.12);
  min-width:0;
  font-weight: 850;
  font-size: clamp(11px, 1.7vw, 13.5px);
  color: rgba(255,255,255,.92);
}
.td:last-child{border-right:none;}

.month{
  color:#111;
  font-weight: 950;
  letter-spacing:.6px;
  text-transform:uppercase;
}
.month.a{ background: var(--monthA); }
.month.b{ background: var(--monthB); }

.ref, .agent, .fait, .justif{
  background: rgba(0,0,0,.10);
}

.agentBox{
  width:100%;
  max-width: 260px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
}
.agentName{
  flex:1;
  text-align:left;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  font-weight:950;
}
.agentBtn{
  flex:0 0 auto;
  padding: 7px 10px;
  border-radius: 12px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(0,0,0,.22);
  color: rgba(255,255,255,.95);
  font-weight: 950;
  cursor:pointer;
  -webkit-tap-highlight-color: transparent;
}
.agentBtn:active{transform: translateY(1px)}
.agentBtn.locked{ opacity:.55; cursor:not-allowed; }
.agentBtn.mine{ background: rgba(212,106,0,.45); border-color: rgba(255,255,255,.22); }

.faitBtn{
  width:100%;
  max-width: 160px;
  padding: 7px 10px;
  border-radius: 12px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(0,0,0,.22);
  color: rgba(255,255,255,.95);
  font-weight: 950;
  cursor:pointer;
  -webkit-tap-highlight-color: transparent;
}
.faitBtn:active{transform: translateY(1px)}
.faitBtn.locked{ opacity:.55; cursor:not-allowed; }

.faitCell.ok{ background: var(--okGreen); }
.faitCell.bad{ background: var(--badRed); }

.justifText{
  width:100%;
  padding: 0 6px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  opacity:.95;
  text-align:left;
}

/* inventaire placeholder */
.inv{
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  padding: 14px;
  text-align:center;
  color: rgba(255,255,255,.86);
  font-weight:900;
  font-size: clamp(14px, 2.2vw, 18px);
}

@media (max-width:360px){
  .th{padding:8px 5px}
  .td{padding:4px 5px}
  .agentBtn,.faitBtn{padding:6px 8px}
}
</style>
</head>

<body>
<div class="bg"></div>

<div class="wrap">
  <div class="topbar">
    <h1 class="title">Désinfection VSAV 2026</h1>
    <button class="btn" id="btnBack">Retour</button>
  </div>

  <div class="tabs" role="tablist" aria-label="Désinfection VSAV onglets">
    <button class="tab active" id="tabInscription" role="tab" aria-selected="true">Inscription</button>
    <button class="tab" id="tabInventaire" role="tab" aria-selected="false">Inventaire</button>
  </div>

  <section class="card" id="panelInscription" role="tabpanel" aria-labelledby="tabInscription">
    <div class="banner">Désinfection VSAV 2026</div>

    <div class="table">
      <div class="thead">
        <div class="th">MOIS</div>
        <div class="th">RÉFÉRENT</div>
        <div class="th">AGENT</div>
        <div class="th">FAIT</div>
        <div class="th">JUSTIFICATIF</div>
      </div>

      <div class="tbody" id="tbody">
        <!-- 12 lignes fixes -->
      </div>
    </div>
  </section>

  <section class="card" id="panelInventaire" role="tabpanel" aria-labelledby="tabInventaire" style="display:none;">
    <div class="banner">Inventaire VSAV</div>
    <div class="inv">(Structure inventaire à ajouter plus tard)</div>
  </section>
</div>

<script>
/* =========================
   CONFIG
   ========================= */
const API = "TON_URL_EXEC_ICI";                 // ✅ METS TON /exec ICI
const LS_KEY = "cs_portail_email_v1";           // ✅ email stocké par le portail

/* ✅ Fix Android / Samsung */
function setAppHeight(){
  document.documentElement.style.setProperty("--appH", window.innerHeight + "px");
}
window.addEventListener("resize", setAppHeight);
window.addEventListener("orientationchange", setAppHeight);
setAppHeight();

/* ✅ Retour vers portail (évite retour login) */
document.getElementById("btnBack").addEventListener("click", ()=>{
  location.href = "index.html?portal=1";
});

/* Tabs */
const tabIns = document.getElementById("tabInscription");
const tabInv = document.getElementById("tabInventaire");
const panIns = document.getElementById("panelInscription");
const panInv = document.getElementById("panelInventaire");
function setTab(which){
  const ins = (which==="ins");
  tabIns.classList.toggle("active", ins);
  tabInv.classList.toggle("active", !ins);
  tabIns.setAttribute("aria-selected", ins ? "true" : "false");
  tabInv.setAttribute("aria-selected", ins ? "false" : "true");
  panIns.style.display = ins ? "flex" : "none";
  panInv.style.display = ins ? "none" : "flex";
}
tabIns.addEventListener("click", ()=>setTab("ins"));
tabInv.addEventListener("click", ()=>setTab("inv"));

/* =========================
   JSONP
   ========================= */
function jsonp(url, cbName, timeoutMs=15000){
  return new Promise((resolve, reject)=>{
    const s = document.createElement("script");
    const cleanup = ()=>{
      s.remove();
      try{ delete window[cbName]; }catch(e){ window[cbName]=undefined; }
    };
    const t = setTimeout(()=>{ cleanup(); reject(new Error("Timeout JSONP")); }, timeoutMs);
    window[cbName] = (data)=>{ clearTimeout(t); cleanup(); resolve(data); };
    s.src = url + (url.includes("?") ? "&" : "?") + "_t=" + Date.now();
    s.onerror = ()=>{ clearTimeout(t); cleanup(); reject(new Error("Erreur JSONP")); };
    document.head.appendChild(s);
  });
}

function myEmail(){
  return (localStorage.getItem(LS_KEY) || "").trim().toLowerCase();
}

/* =========================
   API CALLS attendus
   =========================
   - auth_check : ?view=auth_check&email=...
   - vsav_get   : retourne rows[12] avec:
        mois, referent_name, referent_email, agent_name, agent_email,
        fait_status ("OK"/"NO"/""), fait_date ("jj/mm/aaaa" ou ""), justificatif ("")
   - vsav_set_agent   : month + email
   - vsav_unset_agent : month + email
   - vsav_set_fait    : month + email + date
   - vsav_set_nonfait : month + email + justificatif
*/
async function apiAuthCheck(email){
  const cb = "cb_auth_" + Math.random().toString(36).slice(2);
  const url = `${API}?view=auth_check&email=${encodeURIComponent(email)}&callback=${cb}&nocache=1`;
  return await jsonp(url, cb, 15000);
}
async function apiVsavGet(){
  const cb = "cb_get_" + Math.random().toString(36).slice(2);
  const url = `${API}?view=vsav_get&callback=${cb}&nocache=1`;
  return await jsonp(url, cb, 15000);
}
async function apiAction(view, params){
  const cb = "cb_act_" + Math.random().toString(36).slice(2);
  const qs = Object.entries(params||{}).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join("&");
  const url = `${API}?view=${encodeURIComponent(view)}&${qs}&callback=${cb}&nocache=1`;
  return await jsonp(url, cb, 15000);
}

/* =========================
   UI BUILD
   ========================= */
const MONTHS = ["JANVIER","FÉVRIER","MARS","AVRIL","MAI","JUIN","JUILLET","AOÛT","SEPTEMBRE","OCTOBRE","NOVEMBRE","DÉCEMBRE"];

function buildRows(){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";
  for(let i=0;i<12;i++){
    const m = MONTHS[i];
    const ab = (i%2===0) ? "a" : "b";

    const row = document.createElement("div");
    row.className = "tr";
    row.innerHTML = `
      <div class="td month ${ab}">${m}</div>
      <div class="td ref" data-cell="ref">—</div>

      <div class="td agent" data-cell="agent">
        <div class="agentBox">
          <div class="agentName" data-cell="agentName">—</div>
          <button class="agentBtn" data-month="${m}">S’inscrire</button>
        </div>
      </div>

      <div class="td fait faitCell" data-cell="fait">
        <button class="faitBtn" data-month="${m}">—</button>
      </div>

      <div class="td justif" data-cell="justif">
        <div class="justifText" title="" data-cell="justifText">—</div>
      </div>
    `;
    tbody.appendChild(row);
  }
}

/* Helpers */
function isSameEmail(a,b){
  return String(a||"").trim().toLowerCase() === String(b||"").trim().toLowerCase();
}
function fmtDateFR(iso){
  // iso yyyy-mm-dd -> dd/mm/yyyy
  if(!iso) return "";
  const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return iso;
  return `${m[3]}/${m[2]}/${m[1]}`;
}
function isoFromFR(fr){
  const m = String(fr||"").match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if(!m) return "";
  return `${m[3]}-${m[2]}-${m[1]}`;
}

/* Fill from API rows */
function render(rows, me){
  const tbody = document.getElementById("tbody");
  for(let i=0;i<12;i++){
    const tr = tbody.children[i];
    const r = rows && rows[i] ? rows[i] : {};

    const mois = (r.mois ?? r[0] ?? MONTHS[i]).toString().trim().toUpperCase();
    const refName = (r.referent_name ?? r.referent ?? r[1] ?? "").toString().trim();
    const refEmail= (r.referent_email ?? r.ref_email ?? r[2] ?? "").toString().trim().toLowerCase();

    const agentName = (r.agent_name ?? r.agent ?? r[3] ?? "").toString().trim();
    const agentEmail= (r.agent_email ?? r.agent_mail ?? r[4] ?? "").toString().trim().toLowerCase();

    const faitStatus = (r.fait_status ?? r.status ?? r[5] ?? "").toString().trim().toUpperCase(); // OK / NO / ""
    const faitDate   = (r.fait_date ?? r.date ?? r[6] ?? "").toString().trim();                  // "dd/mm/yyyy"
    const justificatif = (r.justificatif ?? r[7] ?? "").toString().trim();

    // ref
    tr.querySelector('[data-cell="ref"]').textContent = refName || "—";

    // agent cell
    const nameEl = tr.querySelector('[data-cell="agentName"]');
    nameEl.textContent = agentName || "—";

    const btn = tr.querySelector(".agentBtn");
    btn.dataset.month = mois;

    // état bouton agent
    if(!agentEmail){
      btn.textContent = "S’inscrire";
      btn.classList.remove("locked","mine");
      btn.disabled = false;
    }else if(isSameEmail(agentEmail, me)){
      btn.textContent = "Annuler";
      btn.classList.remove("locked");
      btn.classList.add("mine");
      btn.disabled = false;
    }else{
      btn.textContent = "Pris";
      btn.classList.add("locked");
      btn.classList.remove("mine");
      btn.disabled = true;
    }

    // FAIT
    const faitBtn = tr.querySelector(".faitBtn");
    faitBtn.dataset.month = mois;

    const faitCell = tr.querySelector(".faitCell");
    faitCell.classList.remove("ok","bad");

    // bouton FAIT visible (mais cliquable seulement si je suis référent email)
    const isRef = !!refEmail && isSameEmail(refEmail, me);

    if(faitStatus === "OK"){
      faitBtn.textContent = faitDate ? faitDate : "Fait";
      faitCell.classList.add("ok");
    }else if(faitStatus === "NO"){
      faitBtn.textContent = "Non fait";
      faitCell.classList.add("bad");
    }else{
      faitBtn.textContent = "—";
    }

    // lock si pas référent
    faitBtn.disabled = !isRef;
    faitBtn.classList.toggle("locked", !isRef);

    // justificatif
    const jEl = tr.querySelector('[data-cell="justifText"]');
    jEl.textContent = justificatif ? justificatif : "—";
    jEl.title = justificatif || "";
  }
}

/* =========================
   ACTIONS
   ========================= */
async function refresh(){
  const me = myEmail();
  const res = await apiVsavGet();
  if(res && res.ok){
    render(res.rows || [], me);
  }
}

function attachHandlers(){
  document.querySelectorAll(".agentBtn").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const me = myEmail();
      if(!me){ alert("Email non détecté (reviens au portail)."); return; }

      const month = btn.dataset.month;
      const doUnset = (btn.textContent === "Annuler");

      try{
        const view = doUnset ? "vsav_unset_agent" : "vsav_set_agent";
        const r = await apiAction(view, { month, email: me });
        if(!r || !r.ok){ alert((r && r.error) ? r.error : "Erreur"); return; }
        await refresh();
      }catch(e){
        alert("Erreur réseau");
      }
    });
  });

  document.querySelectorAll(".faitBtn").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const me = myEmail();
      if(!me){ alert("Email non détecté (reviens au portail)."); return; }

      const month = btn.dataset.month;

      // choix Fait / Non fait
      const choice = prompt('Tape "F" pour Fait, "N" pour Non fait', "F");
      if(!choice) return;

      const c = choice.trim().toUpperCase();

      if(c === "F"){
        // calendrier
        const iso = prompt("Date (format AAAA-MM-JJ) :", "");
        if(!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)){
          alert("Date invalide. Exemple: 2026-04-12");
          return;
        }
        const fr = fmtDateFR(iso);

        const ok = confirm(`Confirmer validation FAIT au ${fr} ?`);
        if(!ok) return;

        try{
          const r = await apiAction("vsav_set_fait", { month, email: me, date: fr });
          if(!r || !r.ok){ alert((r && r.error) ? r.error : "Erreur"); return; }
          await refresh();
        }catch(e){
          alert("Erreur réseau");
        }

      }else if(c === "N"){
        const justif = prompt("Justificatif (obligatoire) :", "");
        if(!justif || !justif.trim()){
          alert("Justificatif obligatoire.");
          return;
        }
        const ok = confirm("Confirmer NON FAIT ?");
        if(!ok) return;

        try{
          const r = await apiAction("vsav_set_nonfait", { month, email: me, justificatif: justif.trim() });
          if(!r || !r.ok){ alert((r && r.error) ? r.error : "Erreur"); return; }
          await refresh();
        }catch(e){
          alert("Erreur réseau");
        }

      }else{
        alert("Choix invalide.");
      }
    });
  });
}

/* =========================
   BOOT (sécurisé)
   ========================= */
(async function(){
  buildRows();

  // ⚠️ Sécurité: si pas d’email stocké -> retour portail
  const me = myEmail();
  if(!me){
    // pas de blabla : on évite les écrans “bizarres”
    location.href = "index.html";
    return;
  }

  // Vérif accès côté Acces (bloque si non autorisé)
  try{
    const a = await apiAuthCheck(me);
    if(!a || a.ok !== true){
      localStorage.removeItem(LS_KEY);
      location.href = "index.html";
      return;
    }
  }catch(e){
    // si API HS : on bloque (pas d’accès fantôme)
    location.href = "index.html";
    return;
  }

  // load table
  try{
    const res = await apiVsavGet();
    if(res && res.ok){
      render(res.rows || [], me);
    }
  }catch(e){
    // on laisse les —
  }

  attachHandlers();
})();
</script>

</body>
</html>
