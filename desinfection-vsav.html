<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Désinfection VSAV 2026 — CS Consenvoye</title>

<style>
:root{
  --bg:#000;
  --txt:#fff;

  --orange:#d46a00;
  --orange2:#b95800;

  --card: rgba(0,0,0,.50);
  --stroke: rgba(255,255,255,.12);

  --head:#d8d8d8;     /* ✅ entête gris clair */
  --headTxt:#111;

  --yellowTitle:#fff200;
  --monthA:#bcd5ee;
  --monthB:#ffe39c;

  --ok:#25c46a;
  --bad:#ff3b30;

  --shadow: 0 14px 34px rgba(0,0,0,.40);
  --radius: 18px;

  --appH: 100dvh;
}

*{box-sizing:border-box}
html,body{height:100%}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background: var(--bg);
  color: var(--txt);
  overflow:hidden;
  overscroll-behavior:none;
  height: var(--appH);
}

.bg{
  position:fixed; inset:0;
  background:
    linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.55)),
    url("background.png") center top/cover no-repeat;
  z-index:-2;
}
.bg::after{
  content:"";
  position:absolute; inset:0;
  background: radial-gradient(circle at 50% 10%, rgba(255,170,60,.16), rgba(0,0,0,.72) 62%);
  z-index:-1;
}

.wrap{
  height: var(--appH);
  width:min(980px, 100%);
  margin:0 auto;
  padding:
    calc(env(safe-area-inset-top) + 10px)
    12px
    calc(env(safe-area-inset-bottom) + 12px);
  display:grid;
  grid-template-rows: auto auto 1fr;
  gap: 10px;
  overflow:hidden;
  min-height:0;
}

.topbar{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding: 10px 12px;
  border-radius: var(--radius);
  background: linear-gradient(180deg, rgba(212,106,0,.75), rgba(185,88,0,.55));
  border: 1px solid rgba(255,255,255,.12);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  min-height: 46px;
}
.topbar .title{
  margin:0;
  font-weight:950;
  letter-spacing:.6px;
  text-transform: uppercase;
  font-size: clamp(15px, 2.2vw, 18px);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.btn{
  border:1px solid rgba(255,255,255,.18);
  background: rgba(0,0,0,.18);
  color:var(--txt);
  padding: 9px 12px;
  border-radius: 14px;
  font-weight:900;
  cursor:pointer;
  -webkit-tap-highlight-color: transparent;
  white-space:nowrap;
}
.btn:active{transform: translateY(1px)}

.tabs{ display:flex; gap:10px; }
.tab{
  flex:1;
  padding: 10px 12px;
  border-radius: var(--radius);
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.28);
  box-shadow: var(--shadow);
  font-weight:950;
  letter-spacing:.3px;
  cursor:pointer;
  color: rgba(255,255,255,.86);
  -webkit-tap-highlight-color: transparent;
}
.tab.active{
  background: linear-gradient(180deg, rgba(212,106,0,.62), rgba(185,88,0,.45));
  color:#fff;
  border-color: rgba(255,255,255,.16);
}
.tab:active{transform: translateY(1px)}

.card{
  border-radius: 22px;
  background: linear-gradient(180deg, rgba(0,0,0,.52), rgba(0,0,0,.32));
  border:1px solid rgba(255,255,255,.12);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  overflow:hidden;
  min-height:0;
  display:flex;
  flex-direction:column;
}

.banner{
  background: var(--yellowTitle);
  color:#000;
  font-weight: 950;
  text-align:center;
  padding: 10px 10px;
  border-bottom: 2px solid rgba(0,0,0,.25);
  letter-spacing:.8px;
  font-size: clamp(16px, 2.6vw, 22px);
}

.table{
  flex:1;
  display:grid;
  grid-template-rows: auto 1fr;
  min-height:0;
}

.thead{
  display:grid;
  grid-template-columns: 1.05fr 1fr 1fr .85fr;
  background: var(--head);           /* ✅ gris clair */
  color: var(--headTxt);
  font-weight:950;
  text-transform:uppercase;
  letter-spacing:.6px;
  border-bottom: 2px solid rgba(0,0,0,.25);
}
.th{
  padding: 10px 10px;
  text-align:center;
  border-right: 2px solid rgba(0,0,0,.18);
  font-size: clamp(12px, 1.9vw, 14px);
}
.th:last-child{border-right:none;}

.tbody{
  display:grid;
  grid-template-rows: repeat(12, 1fr);
  min-height:0;
}
.tr{
  display:grid;
  grid-template-columns: 1.05fr 1fr 1fr .85fr;
  border-bottom: 2px solid rgba(255,255,255,.12);
}
.tr:last-child{border-bottom:none;}

.td{
  display:flex;
  align-items:center;
  justify-content:center;
  padding: 6px 8px;
  text-align:center;
  border-right: 2px solid rgba(255,255,255,.12);
  min-width:0;
  font-weight: 850;
  font-size: clamp(11px, 1.75vw, 14px);
  color: rgba(255,255,255,.92);
}
.td:last-child{border-right:none;}

.month{
  color:#111;
  font-weight: 950;
  letter-spacing:.6px;
  text-transform:uppercase;
}
.month.a{ background: var(--monthA); }
.month.b{ background: var(--monthB); }

.ref, .agent, .fait{
  background: rgba(0,0,0,.10);
}

/* ✅ bouton agent */
.agentBtn{
  width:100%;
  max-width: 240px;
  padding: 8px 10px;
  border-radius: 12px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(0,0,0,.20);
  color: rgba(255,255,255,.95);
  font-weight: 900;
  cursor:pointer;
  -webkit-tap-highlight-color: transparent;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.agentBtn.locked{ opacity:.55; cursor:not-allowed; }
.agentBtn.mine{ background: rgba(212,106,0,.45); border-color: rgba(255,255,255,.22); }

/* ✅ bouton fait */
.faitBtn{
  width:100%;
  max-width: 190px;
  padding: 8px 10px;
  border-radius: 12px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(0,0,0,.20);
  color: rgba(255,255,255,.95);
  font-weight: 950;
  cursor:pointer;
  -webkit-tap-highlight-color: transparent;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.faitBtn.disabled{ opacity:.45; cursor:not-allowed; }
.faitBtn.ok{ background: rgba(37,196,106,.22); border-color: rgba(37,196,106,.55); }
.faitBtn.bad{ background: rgba(255,59,48,.20); border-color: rgba(255,59,48,.55); }

/* ✅ modal */
.modal{
  position:fixed; inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  padding: 18px;
  z-index: 99999;
}
.modal.show{ display:flex; }
.modal .backdrop{
  position:absolute; inset:0;
  background: rgba(0,0,0,.62);
  backdrop-filter: blur(6px);
}
.modal .box{
  position:relative;
  width:min(520px, 100%);
  border-radius: 18px;
  background: rgba(10,10,10,.92);
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: 0 22px 60px rgba(0,0,0,.65);
  padding: 14px;
}
.modal h3{
  margin: 6px 6px 10px;
  font-size: 16px;
  letter-spacing:.3px;
}
.modal .row{
  display:flex;
  gap:10px;
  margin: 10px 6px 6px;
}
.modal .row .btn2{
  flex:1;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
  color:#fff;
  font-weight: 950;
  cursor:pointer;
}
.modal .row .btn2.primary{
  background: linear-gradient(180deg, rgba(212,106,0,.75), rgba(185,88,0,.55));
}
.modal .row .btn2.ok{
  background: rgba(37,196,106,.24);
  border-color: rgba(37,196,106,.55);
}
.modal .row .btn2.bad{
  background: rgba(255,59,48,.22);
  border-color: rgba(255,59,48,.55);
}
.modal .field{
  margin: 10px 6px 0;
}
.modal input[type="date"],
.modal textarea{
  width:100%;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.35);
  color:#fff;
  padding: 10px 10px;
  font-weight: 800;
}
.modal textarea{ min-height: 92px; resize:none; }

@media (max-width:360px){
  .th{padding:8px 6px}
  .td{padding:5px 6px}
  .agentBtn{padding:7px 8px}
  .faitBtn{padding:7px 8px}
}
  /* ✅ FIX S24 / écrans pas assez hauts : on compacte pour que DÉCEMBRE reste visible */
@media (max-height: 820px){
  .wrap{
    padding-top: calc(env(safe-area-inset-top) + 6px);
    padding-bottom: calc(env(safe-area-inset-bottom) + 6px);
    gap: 8px;
  }

  .topbar{ padding: 8px 10px; min-height: 42px; }
  .tabs{ gap: 8px; }
  .tab{ padding: 8px 10px; }

  .banner{ padding: 6px 8px; font-size: 16px; }

  .th{ padding: 7px 6px; font-size: 12px; }
  .td{ padding: 4px 6px; font-size: 12px; }

  .agentBtn{ padding: 7px 8px; }
  .faitBtn{ padding: 7px 8px; }
}
  .agentBtn.loading{
  background: #1e7a3a !important;
  border-color: #1e7a3a !important;
  color:#fff;
}
  .agentBtn{
  padding: 7px 8px;
  width: 100%;
  white-space: nowrap;
}

  /* Mobile: évite que les dernières lignes soient masquées */
body { padding-bottom: 90px; }
</style>
</head>

<body>
<div class="bg"></div>

<div class="wrap">

  <div class="topbar">
    <h1 class="title">Désinfection VSAV 2026</h1>
    <button class="btn" id="btnBack">Retour</button>
  </div>

  <div class="tabs" role="tablist" aria-label="Désinfection VSAV onglets">
    <button class="tab active" id="tabInscription" role="tab" aria-selected="true">Inscription</button>
    <button class="tab" id="tabInventaire" role="tab" aria-selected="false">Inventaire</button>
  </div>

  <section class="card" id="panelInscription" role="tabpanel" aria-labelledby="tabInscription">
    <div class="banner">DÉSINFECTION VSAV 2026</div>

    <div class="table">
      <div class="thead">
        <div class="th">MOIS</div>
        <div class="th">RÉFÉRENT</div>
        <div class="th">AGENT</div>
        <div class="th">FAIT</div>
      </div>

      <div class="tbody" id="tbody">
        <!-- 12 lignes fixes -->
        <div class="tr" data-month="JANVIER"><div class="td month a">JANVIER</div><div class="td ref">—</div><div class="td agent"><button class="agentBtn">S’inscrire</button></div><div class="td fait"><button class="faitBtn disabled" disabled>—</button></div></div>
        <div class="tr" data-month="FÉVRIER"><div class="td month b">FÉVRIER</div><div class="td ref">—</div><div class="td agent"><button class="agentBtn">S’inscrire</button></div><div class="td fait"><button class="faitBtn disabled" disabled>—</button></div></div>
        <div class="tr" data-month="MARS"><div class="td month a">MARS</div><div class="td ref">—</div><div class="td agent"><button class="agentBtn">S’inscrire</button></div><div class="td fait"><button class="faitBtn disabled" disabled>—</button></div></div>
        <div class="tr" data-month="AVRIL"><div class="td month b">AVRIL</div><div class="td ref">—</div><div class="td agent"><button class="agentBtn">S’inscrire</button></div><div class="td fait"><button class="faitBtn disabled" disabled>—</button></div></div>
        <div class="tr" data-month="MAI"><div class="td month a">MAI</div><div class="td ref">—</div><div class="td agent"><button class="agentBtn">S’inscrire</button></div><div class="td fait"><button class="faitBtn disabled" disabled>—</button></div></div>
        <div class="tr" data-month="JUIN"><div class="td month b">JUIN</div><div class="td ref">—</div><div class="td agent"><button class="agentBtn">S’inscrire</button></div><div class="td fait"><button class="faitBtn disabled" disabled>—</button></div></div>
        <div class="tr" data-month="JUILLET"><div class="td month a">JUILLET</div><div class="td ref">—</div><div class="td agent"><button class="agentBtn">S’inscrire</button></div><div class="td fait"><button class="faitBtn disabled" disabled>—</button></div></div>
        <div class="tr" data-month="AOÛT"><div class="td month b">AOÛT</div><div class="td ref">—</div><div class="td agent"><button class="agentBtn">S’inscrire</button></div><div class="td fait"><button class="faitBtn disabled" disabled>—</button></div></div>
        <div class="tr" data-month="SEPTEMBRE"><div class="td month a">SEPTEMBRE</div><div class="td ref">—</div><div class="td agent"><button class="agentBtn">S’inscrire</button></div><div class="td fait"><button class="faitBtn disabled" disabled>—</button></div></div>
        <div class="tr" data-month="OCTOBRE"><div class="td month b">OCTOBRE</div><div class="td ref">—</div><div class="td agent"><button class="agentBtn">S’inscrire</button></div><div class="td fait"><button class="faitBtn disabled" disabled>—</button></div></div>
        <div class="tr" data-month="NOVEMBRE"><div class="td month a">NOVEMBRE</div><div class="td ref">—</div><div class="td agent"><button class="agentBtn">S’inscrire</button></div><div class="td fait"><button class="faitBtn disabled" disabled>—</button></div></div>
        <div class="tr" data-month="DÉCEMBRE"><div class="td month b">DÉCEMBRE</div><div class="td ref">—</div><div class="td agent"><button class="agentBtn">S’inscrire</button></div><div class="td fait"><button class="faitBtn disabled" disabled>—</button></div></div>
      </div>
    </div>
  </section>

  <section class="card" id="panelInventaire" role="tabpanel" aria-labelledby="tabInventaire" style="display:none;">
    <div class="banner">INVENTAIRE VSAV</div>
    <div style="flex:1;display:flex;align-items:center;justify-content:center;padding:14px;text-align:center;font-weight:900;color:rgba(255,255,255,.86)">
      (Placeholder inventaire)
    </div>
  </section>

</div>

<!-- ✅ MODAL -->
<div class="modal" id="modal">
  <div class="backdrop" id="modalClose"></div>
  <div class="box" id="modalBox"></div>
</div>

<script>
/* ✅ vraie hauteur Android */
function setAppHeight(){
  document.documentElement.style.setProperty("--appH", window.innerHeight + "px");
}
window.addEventListener("resize", setAppHeight);
window.addEventListener("orientationchange", setAppHeight);
setAppHeight();

/* ✅ Retour */
document.getElementById("btnBack").addEventListener("click", ()=>{
  location.href = "index.html?portal=1";
});

/* ✅ Tabs */
const tabIns = document.getElementById("tabInscription");
const tabInv = document.getElementById("tabInventaire");
const panIns = document.getElementById("panelInscription");
const panInv = document.getElementById("panelInventaire");
function setTab(which){
  const ins = (which==="ins");
  tabIns.classList.toggle("active", ins);
  tabInv.classList.toggle("active", !ins);
  tabIns.setAttribute("aria-selected", ins ? "true" : "false");
  tabInv.setAttribute("aria-selected", ins ? "false" : "true");
  panIns.style.display = ins ? "flex" : "none";
  panInv.style.display = ins ? "none" : "flex";
}
tabIns.addEventListener("click", ()=>setTab("ins"));
tabInv.addEventListener("click", ()=>setTab("inv"));

/* =======================
   CONFIG API + IDENTITÉ
   ======================= */
const API = "https://script.google.com/macros/s/AKfycbzPHCDdW7wkFCVkMOL_2srZmdnjZ1QKmToUFtqIZBPjSUNtOwM-Ac7ua0w9dhCv3oI/exec";
const LS_EMAIL = "cs_portail_email_v1";
const LS_NAME = "cs_portail_name_v1";

  function requireIdentity(){
  let email = myEmail();
  if(email) return true;

  // 1) tentative via URL (si tu arrives depuis index avec ?email=...&name=...)
  const u = new URL(location.href);
  const pEmail = (u.searchParams.get("email") || "").trim().toLowerCase();
  const pName = (u.searchParams.get("name") || "").trim();

  if(pEmail){
    localStorage.setItem(LS_EMAIL, pEmail);
    if(pName) localStorage.setItem(LS_NAME, pName);
    return true;
  }

  // 2) sinon on demande UNE fois
  email = prompt("Email de connexion (obligatoire) :","") || "";
  email = email.trim().toLowerCase();
  if(!email) return false;

  const name = (prompt("Prénom (optionnel) :","") || "").trim();

  localStorage.setItem(LS_EMAIL, email);
  if(name) localStorage.setItem(LS_NAME, name);

  return true;
}


function myEmail(){
  return (localStorage.getItem(LS_EMAIL) || "").trim().toLowerCase();
}
function myName(){
  return (localStorage.getItem(LS_NAME) || "").trim();
}

/* =======================
   JSONP
   ======================= */
function jsonp(url, cbName, timeoutMs=15000){
  return new Promise((resolve, reject)=>{
    const s = document.createElement("script");
    const cleanup = ()=>{
      s.remove();
      try{ delete window[cbName]; }catch(e){ window[cbName]=undefined; }
    };
    const t = setTimeout(()=>{ cleanup(); reject(new Error("Timeout JSONP")); }, timeoutMs);
    window[cbName] = (data)=>{ clearTimeout(t); cleanup(); resolve(data); };
    s.src = url + (url.includes("?") ? "&" : "?") + "_t=" + Date.now();
    s.onerror = ()=>{ clearTimeout(t); cleanup(); reject(new Error("Erreur JSONP")); };
    document.head.appendChild(s);
  });
}

async function apiCall(view, params={}){
  const cb = "cb_" + Math.random().toString(36).slice(2);
  const qs = new URLSearchParams({ view, callback: cb, nocache:"1" });
  Object.entries(params).forEach(([k,v])=> qs.set(k, String(v)));
  const url = `${API}?${qs.toString()}`;
  return await jsonp(url, cb, 20000);
}

/* =======================
   MODAL
   ======================= */
const $modal = document.getElementById("modal");
const $modalBox = document.getElementById("modalBox");
document.getElementById("modalClose").addEventListener("click", closeModal);

function openModal(html){
  $modalBox.innerHTML = html;
  $modal.classList.add("show");
}
function closeModal(){
  $modal.classList.remove("show");
  $modalBox.innerHTML = "";
}
function askConfirm(msg){
  return new Promise((resolve)=>{
    openModal(`
      <h3>${msg}</h3>
      <div class="row">
        <button class="btn2 primary" id="mOk">Confirmer</button>
        <button class="btn2" id="mCancel">Annuler</button>
      </div>
    `);
    document.getElementById("mOk").onclick = ()=>{ closeModal(); resolve(true); };
    document.getElementById("mCancel").onclick = ()=>{ closeModal(); resolve(false); };
  });
}

function parseSigned(s){
  s = (s || "").toString().trim();
  if(!s) return { name:"", email:"" };

  if(!s.includes("|")){
    return { name:s, email:"" };
  }

  const parts = s.split("|");
  return {
    name: (parts[0] || "").trim(),
    email: (parts[1] || "").trim().toLowerCase()
  };
}

function fmtFR(iso){
  const m = String(iso||"").match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return iso || "—";
  return `${m[3]}/${m[2]}/${m[1]}`;
}

/* =======================
   REMPLISSAGE TABLE
   attend côté API:
   row.referent (prénom)
   row.referent_email (email)
   row.agent (prénom)
   row.agent_email (email)
   row.status ("done"/"not_done"/"")
   row.date ("YYYY-MM-DD")
   row.justificatif (texte)
   ======================= */
function fill(rows){
  const tbody = document.getElementById("tbody");
  const meEmail = (myEmail() || "").trim().toLowerCase();
  const meName = (myName() || "").trim();

  for(let i=0;i<12;i++){
    const tr = tbody.children[i];
    if(!tr) continue;

    const row = rows[i] || {};
    const mois = (row.mois || tr.dataset.month || "").toString().trim().toUpperCase();
    tr.dataset.month = mois;

    // ✅ référent : prénom + email (droits)
    const refName = (row.referent || "").toString().trim();
    const refEmail = (row.referent_email || "").toString().trim().toLowerCase();

    // ✅ agent : prénom + email (annulation)
    const agName = (row.agent || "").toString().trim();
    const agEmail = (row.agent_email || "").toString().trim().toLowerCase();

    const status = (row.status || "").toString().trim();
    const dateISO= (row.date || "").toString().trim();
    const justif = (row.justificatif || "").toString().trim();

    // REF (affichage) + droits
    tr.children[1].textContent = refName ? refName : "—";
    tr.dataset.refEmail = refEmail || "";

    // ======================
    // AGENT button (affichage + état)
    // ======================
    const btnA = tr.querySelector(".agentBtn");
    if(btnA){
      btnA.classList.remove("locked","mine","loading");
      btnA.disabled = false;

      // 1) Personne inscrit
      if(!agName && !agEmail){
        btnA.textContent = "S’inscrire";
        // ⚠️ le clic est géré par bind() -> onAgentClick(tr)
      }else{
        // 2) Quelqu’un est inscrit
        btnA.textContent = agName || "—";

        // ✅ c’est moi : on compare sur agent_email (PAS parseSigned)
        if(agEmail && meEmail && agEmail === meEmail){
          btnA.classList.add("mine");
          // pas de "(Annuler)" comme tu veux
        }else{
          btnA.classList.add("locked");
          btnA.disabled = true;
        }
      }
    }

    // ======================
    // FAIT (lecture seule ici, comme chez toi)
    // ======================
    const btnF = tr.querySelector(".faitBtn");
    if(btnF){
      btnF.classList.remove("ok","bad","disabled","loading");
      btnF.disabled = false;

      const isRef = (refEmail && meEmail && refEmail === meEmail);

      if(!isRef){
        btnF.classList.add("disabled");
        btnF.disabled = true;
        btnF.textContent = (status==="done" && dateISO) ? fmtFR(dateISO)
                       : (status==="not_done" ? "NON FAIT" : "—");
      }else{
        if(status==="done" && dateISO){
          btnF.classList.add("ok");
          btnF.textContent = fmtFR(dateISO);
        }else if(status==="not_done"){
          btnF.classList.add("bad");
          btnF.textContent = "NON FAIT";
        }else{
          btnF.textContent = "—";
        }
      }

      tr.dataset.status = status || "";
      tr.dataset.date = dateISO || "";
      tr.dataset.justif = justif || "";
    }
  }
}


/* =======================
   ACTIONS
   ======================= */
async function refresh(){
  const res = await apiCall("vsav_get");
  if(res && res.ok) fill(res.rows || []);
}

async function onAgentClick(tr){

  const month = tr.dataset.month;
  const meEmail = (myEmail() || "").toLowerCase();
  const meName = (myName() || "").trim();

  if(!meEmail){
    alert("Email non détecté.");
    return;
  }

  const btnA = tr.querySelector(".agentBtn");
  if(!btnA) return;

  const currentEmail = (tr.dataset.agentEmail || "").toLowerCase();
  const isMine = currentEmail && currentEmail === meEmail;

  const ok = await askConfirm(
    isMine
      ? `Annuler ton inscription (${month}) ?`
      : `S’inscrire sur ${month} ?`
  );

  if(!ok) return;

  btnA.classList.add("loading");
  btnA.disabled = true;

  const action = isMine ? "vsav_unset_agent" : "vsav_set_agent";

  const r = await apiCall(
    action,
    isMine
      ? { month, email: meEmail }
      : { month, email: meEmail, name: meName }
  );

  btnA.classList.remove("loading");
  btnA.disabled = false;

  if(!r?.ok){
    alert(r?.error || "Erreur");
    return;
  }

  await refresh();
}


async function onFaitClick(tr){
  const month = tr.dataset.month;
  const me = myEmail();
  const refEmail = (tr.dataset.refEmail || "").toLowerCase();
  if(!me || !refEmail || me !== refEmail){
    return; // sécurité
  }

  openModal(`
    <h3>${month} — Validation</h3>
    <div class="row">
      <button class="btn2 ok" id="mFait">Fait</button>
      <button class="btn2 bad" id="mNon">Non fait</button>
    </div>
    <div class="row">
      <button class="btn2" id="mCancel">Annuler</button>
    </div>
  `);

  document.getElementById("mCancel").onclick = closeModal;

  document.getElementById("mFait").onclick = async ()=>{
    openModal(`
      <h3>${month} — Choisir la date</h3>
      <div class="field">
        <input type="date" id="mDate">
      </div>
      <div class="row">
        <button class="btn2 primary" id="mVal">Valider</button>
        <button class="btn2" id="mBack">Retour</button>
      </div>
    `);
    document.getElementById("mBack").onclick = ()=>onFaitClick(tr);

    document.getElementById("mVal").onclick = async ()=>{
      const d = (document.getElementById("mDate").value || "").trim();
      if(!d){ alert("Choisis une date."); return; }

      const ok = await askConfirm(`Confirmer : Fait le ${fmtFR(d)} ?`);
      if(!ok) return;

      const r = await apiCall("vsav_set_done", { month, email: me, date: d });
      if(!r?.ok){ alert(r?.error || "Erreur"); return; }
      closeModal();
      await refresh();
    };
  };

  document.getElementById("mNon").onclick = async ()=>{
    openModal(`
      <h3>${month} — Non fait (justificatif obligatoire)</h3>
      <div class="field">
        <textarea id="mJustif" placeholder="Justificatif obligatoire…"></textarea>
      </div>
      <div class="row">
        <button class="btn2 primary" id="mVal">Valider</button>
        <button class="btn2" id="mBack">Retour</button>
      </div>
    `);
    document.getElementById("mBack").onclick = ()=>onFaitClick(tr);

    document.getElementById("mVal").onclick = async ()=>{
      const j = (document.getElementById("mJustif").value || "").trim();
      if(!j){ alert("Justificatif obligatoire."); return; }

      const ok = await askConfirm(`Confirmer : NON FAIT ?`);
      if(!ok) return;

      const r = await apiCall("vsav_set_not_done", { month, email: me, justif: j });
      if(!r?.ok){ alert(r?.error || "Erreur"); return; }
      closeModal();
      await refresh();
    };
  };
}

/* bind clicks */
function bind(){
  document.querySelectorAll("#tbody .tr").forEach(tr=>{
    const btnA = tr.querySelector(".agentBtn");
    const btnF = tr.querySelector(".faitBtn");
    if(btnA){
      btnA.onclick = ()=> onAgentClick(tr);
    }
    if(btnF){
      btnF.onclick = ()=> onFaitClick(tr);
    }
  });
}

/* boot */
(async function(){
  try{
    if(!requireIdentity()){
      alert("Connexion obligatoire.");
      location.href = "index.html?portal=1";
      return;
    }
    bind();
    await refresh();
  }catch(e){
    // silence
  }
})();
</script>

</body>
</html>
