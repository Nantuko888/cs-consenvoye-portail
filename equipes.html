<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Équipes — CS Consenvoye</title>

  <style>
    :root{
      --txt:#f4f4f4;
      --muted:#cfcfcf;
      --glass: rgba(0,0,0,.45);
      --glass2: rgba(0,0,0,.30);
      --stroke: rgba(255,170,60,.55);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 22px;
      --blue: #2f7bd3;
      --orange: #d98910;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--txt);
      background:#111;
      min-height:100vh;
    }

    /* Fond figé (IMPORTANT) */
    .bg{
      position:fixed;
      inset:0;
      background:
        linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.55)),
        url("bg.jpg") center/cover no-repeat;
      filter: saturate(0.9);
      z-index:-2;
    }
    .bg::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(circle at 50% 10%, rgba(255,170,60,.18), rgba(0,0,0,.6) 60%);
      z-index:-1;
    }

    .wrap{
      max-width: 520px;
      margin: 0 auto;
      padding: 18px 14px 40px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }

    h1{
      margin:0;
      font-size:34px;
      font-weight:800;
      letter-spacing:.4px;
      text-shadow: 0 10px 22px rgba(0,0,0,.6);
    }

    .actions{
      display:flex;
      gap:10px;
    }
    .btn{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.12);
      color:var(--txt);
      padding:10px 14px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      cursor:pointer;
      font-weight:700;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .btn:active{transform: translateY(1px)}
    .btn.secondary{
      border-color: rgba(255,170,60,.35);
    }

    .card{
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.38));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      overflow:hidden;
      margin: 14px 0;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    /* Bandeau cliquable */
    .team-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 16px;
      user-select:none;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.8px;
      text-transform:uppercase;
    }
    .team-head .left{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:22px;
    }
    .badge{
      min-width: 28px;
      height: 28px;
      padding: 0 10px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius: 999px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.18);
      font-weight:900;
    }

    .team1 .team-head{ background: linear-gradient(180deg, rgba(47,123,211,.95), rgba(47,123,211,.78)); }
    .team2 .team-head{ background: linear-gradient(180deg, rgba(217,137,16,.95), rgba(217,137,16,.78)); }

    /* Corps */
    .team-body{
      padding: 14px 14px 16px;
      background: rgba(0,0,0,.22);
    }

    .table-head{
      display:grid;
      grid-template-columns: 1fr 1.3fr 1fr;
      gap:10px;
      padding: 12px 14px;
      border-radius: 18px;
      background: rgba(0,0,0,.38);
      border:1px solid rgba(255,255,255,.10);
      font-weight:900;
      letter-spacing:.8px;
      text-transform:uppercase;
      color: #ffb15a;
      margin-bottom: 10px;
    }

    .rows{
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1.3fr 1fr;
      gap:10px;
      padding: 12px 14px;
      border-radius: 18px;
      background: rgba(0,0,0,.32);
      border:1px solid rgba(255,255,255,.09);
    }

    .muted{ color: var(--muted); font-style: italic; }
    .status{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px dashed rgba(255,170,60,.35);
      background: rgba(0,0,0,.25);
      color:#ffd19a;
      display:none;
    }

    /* Accordéon : fermé par défaut */
    .is-collapsed .team-body{ display:none; }

    /* Petit chevron */
    .chev{
      width: 10px; height:10px;
      border-right: 3px solid rgba(255,255,255,.85);
      border-bottom: 3px solid rgba(255,255,255,.85);
      transform: rotate(45deg);
      opacity:.85;
      margin-left:6px;
      transition: transform .15s ease;
    }
    .is-collapsed .chev{ transform: rotate(-45deg); }

    @media (max-width:380px){
      h1{font-size:30px}
      .team-head .left{font-size:20px}
    }
  </style>
</head>

<body>
  <div class="bg"></div>

  <div class="wrap">
    <header>
      <h1>Équipes</h1>
      <div class="actions">
        <button class="btn" id="btnRefresh">Actualiser</button>
        <button class="btn secondary" id="btnBack">Retour</button>
      </div>
    </header>

    <!-- ÉQUIPE 1 -->
    <section class="card team1 team-card is-collapsed" data-team="1">
      <div class="team-head">
        <div class="left">Équipe 1 <span class="chev"></span></div>
        <div class="badge" id="count1">0</div>
      </div>
      <div class="team-body">
        <div class="table-head">
          <div>Fonction</div><div>Nom</div><div>Comp</div>
        </div>
        <div class="rows" id="rows1"></div>
        <p class="muted" id="empty1" style="display:none;margin:10px 4px 0;">Aucun nom pour le moment.</p>
      </div>
    </section>

    <!-- ÉQUIPE 2 -->
    <section class="card team2 team-card is-collapsed" data-team="2">
      <div class="team-head">
        <div class="left">Équipe 2 <span class="chev"></span></div>
        <div class="badge" id="count2">0</div>
      </div>
      <div class="team-body">
        <div class="table-head">
          <div>Fonction</div><div>Nom</div><div>Comp</div>
        </div>
        <div class="rows" id="rows2"></div>
        <p class="muted" id="empty2" style="display:none;margin:10px 4px 0;">Aucun nom pour le moment.</p>
      </div>
    </section>

    <div class="status" id="status"></div>
  </div>

<script>
/** ✅ TON URL APPS SCRIPT /exec (JSONP) */
const API = "https://script.google.com/macros/s/AKfycbzPHCDdW7wkFCVkMOL_2srZmdnjZ1QKmToUFtqIZBPjSUNtOwM-Ac7ua0w9dhCv3oI/exec";

/** Liens */
const BACK_URL = "index.html"; // ajuste si besoin

const $status = document.getElementById("status");
const $rows1 = document.getElementById("rows1");
const $rows2 = document.getElementById("rows2");
const $empty1 = document.getElementById("empty1");
const $empty2 = document.getElementById("empty2");
const $count1 = document.getElementById("count1");
const $count2 = document.getElementById("count2");

document.getElementById("btnBack").addEventListener("click", () => location.href = BACK_URL);
document.getElementById("btnRefresh").addEventListener("click", () => loadEquipes(true));

/** Accordéon (fermées par défaut) */
function initAccordion(){
  const cards = Array.from(document.querySelectorAll(".team-card"));

  cards.forEach(card => {
    card.classList.add("is-collapsed");
    const head = card.querySelector(".team-head");
    head.addEventListener("click", () => {
      // toggle uniquement celle cliquée (pas obligé de fermer l'autre)
      card.classList.toggle("is-collapsed");
    });
  });
}

function setStatus(msg, show=true){
  $status.textContent = msg || "";
  $status.style.display = show ? "block" : "none";
}

/** JSONP */
function jsonp(url, cbName){
  return new Promise((resolve, reject) => {
    const script = document.createElement("script");
    const cleanup = () => {
      script.remove();
      try { delete window[cbName]; } catch(e){ window[cbName] = undefined; }
    };

    const timer = setTimeout(() => {
      cleanup();
      reject(new Error("Timeout JSONP"));
    }, 12000);

    window[cbName] = (data) => {
      clearTimeout(timer);
      cleanup();
      resolve(data);
    };

    script.src = url;
    script.onerror = () => {
      clearTimeout(timer);
      cleanup();
      reject(new Error("Erreur JSONP"));
    };
    document.head.appendChild(script);
  });
}

/** Tri fonction (si tu veux un ordre logique) */
const RANK = [
  "chef","cdc","responsable","resp","adjoint","ca","ce","isp","equipier","apprenant"
].reduce((a,k,i)=>(a[k]=i+1,a),{});

function rankFonction(f){
  const s = (f||"").toString().trim().toLowerCase();
  // normalisations rapides
  if(s.includes("chef")) return 1;
  if(s.startsWith("resp")) return 2;
  if(s.includes("adj")) return 3;
  if(s === "ca") return 4;
  if(s === "ce") return 5;
  if(s === "isp") return 6;
  if(s.includes("equip")) return 7;
  if(s.includes("app")) return 8;
  return 999;
}

function renderTeam(teamNum, list){
  const $rows = teamNum === 1 ? $rows1 : $rows2;
  const $empty = teamNum === 1 ? $empty1 : $empty2;
  const $count = teamNum === 1 ? $count1 : $count2;

  $rows.innerHTML = "";
  const arr = Array.isArray(list) ? list.slice() : [];

  // tri: fonction puis nom
  arr.sort((a,b)=>{
    const ra = rankFonction(a.fonction);
    const rb = rankFonction(b.fonction);
    if(ra !== rb) return ra - rb;
    const na = (a.nom||"").toString();
    const nb = (b.nom||"").toString();
    return na.localeCompare(nb, "fr");
  });

  $count.textContent = String(arr.length);

  if(!arr.length){
    $empty.style.display = "block";
    return;
  }
  $empty.style.display = "none";

  for(const r of arr){
    const div = document.createElement("div");
    div.className = "row";
    div.innerHTML = `
      <div>${escapeHtml(r.fonction || "—")}</div>
      <div>${escapeHtml(r.nom || "—")}</div>
      <div>${escapeHtml(r.competences || r.comp || "—")}</div>
    `;
    $rows.appendChild(div);
  }
}

function escapeHtml(s){
  return (s==null ? "" : String(s))
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

async function loadEquipes(showToast){
  try{
    setStatus("Chargement…", true);

    const cb = "cb_" + Math.random().toString(36).slice(2);
    const url = `${API}?view=equipes&callback=${cb}`;

    const data = await jsonp(url, cb);

    if(!data || data.ok === false){
      throw new Error((data && data.error) ? data.error : "Réponse API invalide");
    }

    const teams = data.teams || data.teamsBy || data.equipes || {};
    renderTeam(1, teams["1"] || teams[1] || []);
    renderTeam(2, teams["2"] || teams[2] || []);

    setStatus("", false);
    if(showToast) setStatus("Mis à jour ✅", true), setTimeout(()=>setStatus("",false), 1200);

  }catch(err){
    renderTeam(1, []);
    renderTeam(2, []);
    setStatus("Erreur de chargement (API).", true);
    console.error(err);
  }
}

/** GO */
initAccordion();
loadEquipes(false);
</script>
</body>
</html>
