<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Équipes — CS Consenvoye</title>

  <style>
    :root{
      --txt:#f4f4f4;
      --muted:#cfcfcf;
      --shadow: 0 14px 34px rgba(0,0,0,.38);
      --radius: 22px;
      --blue: #2f7bd3;
      --orange: #d98910;
      --gold: #ffb15a;
    }
    *{box-sizing:border-box}
    html, body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--txt);
      background:#0b0b0b;
      overflow-x:hidden;
    }

    /* Fond figé */
    .bg{
      position:fixed; inset:0;
      background:
        linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.55)),
        url("background.png") center top/cover no-repeat;
      z-index:-2;
      transform: translateZ(0);
    }
    .bg::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(circle at 50% 10%, rgba(255,170,60,.18), rgba(0,0,0,.62) 62%);
      z-index:-1;
    }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 14px 14px 40px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    h1{
      margin:0;
      font-size:30px;
      font-weight:900;
      letter-spacing:.4px;
      text-shadow: 0 10px 22px rgba(0,0,0,.6);
    }
    .actions{display:flex; gap:10px;}
    .btn{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.12);
      color:var(--txt);
      padding:10px 14px;
      border-radius: 16px;
      box-shadow: var(--shadow);
      cursor:pointer;
      font-weight:800;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform: translateY(1px)}
    .btn.secondary{ border-color: rgba(255,170,60,.35); }

    /* Carte (verre) */
    .card{
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(0,0,0,.58), rgba(0,0,0,.36));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    /* ✅ Chef de centre centré */
    .chief{
      margin: 12px 0 14px;
      padding: 14px 16px;
      text-align:center;
    }
    .chief .label{
      font-weight:950;
      letter-spacing: .9px;
      text-transform: uppercase;
      color: var(--gold);
      margin-bottom: 6px;
      text-shadow: 0 10px 22px rgba(0,0,0,.6);
    }
    .chief .name{
      font-size: 22px;
      font-weight: 950;
      text-shadow: 0 10px 22px rgba(0,0,0,.6);
      word-break: break-word; /* nom complet */
    }

    /* ✅ Ligne Équipe 1 / Équipe 2 (toujours sur la même ligne) */
    .team-row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items: stretch;
      margin-top: 12px;
    }

    /* Boutons de choix (pas le tableau) */
    .team-pick{
      padding: 16px 16px 14px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      display:flex;
      flex-direction:column;
      gap:10px;
      justify-content:center;
    }
    .team-pick .title{
      font-size: 20px;
      font-weight: 950;
      letter-spacing: .8px;
      text-transform: uppercase;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .pill{
      min-width: 34px;
      height: 28px;
      padding: 0 10px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:950;
      border:1px solid rgba(255,255,255,.20);
      background: rgba(0,0,0,.25);
    }
    .team-pick .sub{
      color: rgba(255,255,255,.80);
      font-weight:700;
      font-size: 13px;
    }

    .team1-pick{ border:1px solid rgba(47,123,211,.55); }
    .team1-pick .title{ color: #d7e9ff; }
    .team1-pick .accent{
      height: 6px; border-radius: 999px;
      background: linear-gradient(90deg, rgba(47,123,211,1), rgba(47,123,211,.45));
    }

    .team2-pick{ border:1px solid rgba(217,137,16,.55); }
    .team2-pick .title{ color: #ffe5c2; }
    .team2-pick .accent{
      height: 6px; border-radius: 999px;
      background: linear-gradient(90deg, rgba(217,137,16,1), rgba(217,137,16,.45));
    }

    /* Plein écran (overlay) */
    .overlay{
      position: fixed;
      inset: 0;
      z-index: 50;
      background: rgba(0,0,0,.62);
      display:none;
      padding: env(safe-area-inset-top) 12px env(safe-area-inset-bottom) 12px;
    }
    .overlay.is-open{ display:block; }

    .panel{
      height: 100%;
      max-width: 980px;
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .panel-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 14px 16px;
    }
    .panel-head .panel-title{
      margin:0;
      font-size: 20px;
      font-weight: 950;
      letter-spacing: .8px;
      text-transform: uppercase;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .close{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.12);
      color:var(--txt);
      padding:10px 14px;
      border-radius: 16px;
      font-weight:950;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }

    /* Table interne */
    .panel-body{
      flex:1;
      overflow:auto;
      padding: 14px;
      background: rgba(0,0,0,.22);
    }

    .table-head, .row{
      display:grid;
      grid-template-columns: 1fr 1.3fr 1fr;
      gap:10px;
      padding: 12px 14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
    }
    .table-head{
      background: rgba(0,0,0,.38);
      font-weight:950;
      letter-spacing:.8px;
      text-transform:uppercase;
      color: var(--gold);
      margin-bottom:10px;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    .row{
      background: rgba(0,0,0,.32);
      border-color: rgba(255,255,255,.08);
      margin-bottom: 10px;
    }
    .muted{ color: var(--muted); font-style: italic; margin:0; padding: 6px 2px; }

    .status{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px dashed rgba(255,170,60,.35);
      background: rgba(0,0,0,.25);
      color:#ffd19a;
      display:none;
    }

    /* Bandeau couleur dans overlay */
    .panel.team1 .panel-head{ background: linear-gradient(180deg, rgba(47,123,211,.95), rgba(47,123,211,.78)); }
    .panel.team2 .panel-head{ background: linear-gradient(180deg, rgba(217,137,16,.95), rgba(217,137,16,.78)); }

    /* Responsive: on garde équipe1/équipe2 sur la même ligne même mobile */
    @media (max-width: 360px){
      .team-pick .title{ font-size:18px; }
      .team-pick{ padding: 14px 14px 12px; }
    }
  </style>
</head>

<body>
  <div class="bg"></div>

  <div class="wrap">
    <header>
      <h1>Équipes</h1>
      <div class="actions">
                <button class="btn secondary" id="btnBack">Retour</button>
                       
      </div>
    </header>

    <!-- ✅ Chef de centre centré -->
    <section class="card chief">
      <div class="label">Chef de centre</div>
      <div class="name" id="chiefName">—</div>
    </section>

    <!-- ✅ Équipe 1 gauche / Équipe 2 droite (même ligne) -->
    <div class="team-row">
      <section class="card team-pick team1-pick" id="pickTeam1" role="button" aria-label="Ouvrir Équipe 1">
        <div class="title">Équipe 1 <span class="pill" id="count1">0</span></div>
        <div class="sub">Appuie pour afficher en pleine page</div>
        <div class="accent"></div>
      </section>

      <section class="card team-pick team2-pick" id="pickTeam2" role="button" aria-label="Ouvrir Équipe 2">
        <div class="title">Équipe 2 <span class="pill" id="count2">0</span></div>
        <div class="sub">Appuie pour afficher en pleine page</div>
        <div class="accent"></div>
      </section>
    </div>

    <div class="status" id="status"></div>
  </div>

  <!-- ✅ Overlay pleine page -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="panel card" id="panel">
      <div class="panel-head" id="panelHead">
        <div class="panel-title" id="panelTitle">—</div>
        <button class="close" id="btnClose">Fermer</button>
      </div>

      <div class="panel-body">
        <div class="table-head">
          <div>Fonction</div><div>Nom</div><div>Comp</div>
        </div>
        <div id="panelRows"></div>
        <p class="muted" id="panelEmpty" style="display:none;">Aucun nom pour le moment.</p>
      </div>
    </div>
  </div>

<script>
  /** ✅ Mets ici TON URL /exec */
  const API = "https://script.google.com/macros/s/AKfycbzPHCDdW7wkFCVkMOL_2srZmdnjZ1QKmToUFtqIZBPjSUNtOwM-Ac7ua0w9dhCv3oI/exec";
  const BACK_URL = "index.html"; // ajuste si besoin

  const $status = document.getElementById("status");
  const $chiefName = document.getElementById("chiefName");
  const $count1 = document.getElementById("count1");
  const $count2 = document.getElementById("count2");

  const $overlay = document.getElementById("overlay");
  const $panel = document.getElementById("panel");
  const $panelTitle = document.getElementById("panelTitle");
  const $panelRows = document.getElementById("panelRows");
  const $panelEmpty = document.getElementById("panelEmpty");

  document.getElementById("btnBack").addEventListener("click", () => location.href = BACK_URL);
  document.getElementById("btnRefresh").addEventListener("click", () => loadAll(true));

  document.getElementById("btnClose").addEventListener("click", closeOverlay);
  $overlay.addEventListener("click", (e) => { if(e.target === $overlay) closeOverlay(); });

  document.getElementById("pickTeam1").addEventListener("click", () => openTeam(1));
  document.getElementById("pickTeam2").addEventListener("click", () => openTeam(2));

  let TEAMS_CACHE = { "1": [], "2": [] };

  function setStatus(msg, show=true){
    $status.textContent = msg || "";
    $status.style.display = show ? "block" : "none";
  }

  /** JSONP */
  function jsonp(url, cbName){
    return new Promise((resolve, reject) => {
      const script = document.createElement("script");
      const cleanup = () => {
        script.remove();
        try { delete window[cbName]; } catch(e){ window[cbName] = undefined; }
      };
      const timer = setTimeout(() => { cleanup(); reject(new Error("Timeout JSONP")); }, 12000);
      window[cbName] = (data) => { clearTimeout(timer); cleanup(); resolve(data); };
      script.src = url;
      script.onerror = () => { clearTimeout(timer); cleanup(); reject(new Error("Erreur JSONP")); };
      document.head.appendChild(script);
    });
  }

  function escapeHtml(s){
    return (s==null ? "" : String(s))
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function loadChef(){
    const cb = "cb_org_" + Math.random().toString(36).slice(2);
    const url = `${API}?view=org&callback=${cb}`;
    const data = await jsonp(url, cb);
    if(!data || data.ok === false) throw new Error(data?.error || "Réponse org invalide");

    const chef = data?.direction?.chef || "—";
    $chiefName.textContent = chef;
  }

  async function loadEquipes(){
    const cb = "cb_eq_" + Math.random().toString(36).slice(2);
    const url = `${API}?view=equipes&callback=${cb}`;
    const data = await jsonp(url, cb);
    if(!data || data.ok === false) throw new Error(data?.error || "Réponse équipes invalide");

    const teams = data.teams || data.equipes || {};
    const t1 = teams["1"] || teams[1] || [];
    const t2 = teams["2"] || teams[2] || [];
    TEAMS_CACHE["1"] = Array.isArray(t1) ? t1 : [];
    TEAMS_CACHE["2"] = Array.isArray(t2) ? t2 : [];

    $count1.textContent = String(TEAMS_CACHE["1"].length);
    $count2.textContent = String(TEAMS_CACHE["2"].length);
  }

  async function loadAll(showToast){
    try{
      setStatus("Chargement…", true);
      await Promise.all([loadChef(), loadEquipes()]);
      setStatus("", false);
      if(showToast){
        setStatus("Mis à jour ✅", true);
        setTimeout(()=>setStatus("", false), 1200);
      }
    }catch(err){
      console.error(err);
      setStatus("Erreur de chargement (API).", true);
    }
  }

  function openTeam(n){
    const teamKey = String(n);
    const title = (n === 1) ? "Équipe 1" : "Équipe 2";

    // style bandeau + classe
    $panel.classList.remove("team1","team2");
    $panel.classList.add(n === 1 ? "team1" : "team2");

    $panelTitle.textContent = title;

    // remplir
    const arr = TEAMS_CACHE[teamKey] || [];
    $panelRows.innerHTML = "";
    if(!arr.length){
      $panelEmpty.style.display = "block";
    }else{
      $panelEmpty.style.display = "none";
      for(const r of arr){
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div>${escapeHtml(r.fonction || "—")}</div>
          <div>${escapeHtml(r.nom || "—")}</div>
          <div>${escapeHtml(r.competences || r.comp || "—")}</div>
        `;
        $panelRows.appendChild(row);
      }
    }

    // ouvrir plein écran
    $overlay.classList.add("is-open");
    $overlay.setAttribute("aria-hidden", "false");

    // empêche le scroll derrière
    document.body.style.overflow = "hidden";
  }

  function closeOverlay(){
    $overlay.classList.remove("is-open");
    $overlay.setAttribute("aria-hidden", "true");
    document.body.style.overflow = "";
  }

  /** GO AVEC CACHE */

const CACHE_KEY = "cs_equipes_cache";
const CACHE_TIME = 5 * 60 * 1000; // 5 minutes

function loadWithCache(){
  const raw = localStorage.getItem(CACHE_KEY);
  if(raw){
    try{
      const cache = JSON.parse(raw);
      const age = Date.now() - cache.time;

      if(age < CACHE_TIME){
        // On recharge depuis le cache
        TEAMS_CACHE = cache.teams;
        $count1.textContent = String(TEAMS_CACHE["1"].length);
        $count2.textContent = String(TEAMS_CACHE["2"].length);
        $chiefName.textContent = cache.chef || "—";
        return; // STOP ici
      }
    }catch(e){}
  }

  // Sinon on recharge depuis l’API
  loadAll(false).then(() => {
    localStorage.setItem(CACHE_KEY, JSON.stringify({
      time: Date.now(),
      teams: TEAMS_CACHE,
      chef: $chiefName.textContent
    }));
  });
}

loadWithCache();

</script>
</body>
</html>
