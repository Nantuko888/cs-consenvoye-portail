<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Planning 2026 — CS Consenvoye</title>

  <style>
    :root{
      --txt:#f4f4f4;
      --shadow: 0 14px 34px rgba(0,0,0,.38);
      --line: rgba(255,255,255,.10);
      --glass1: rgba(0,0,0,.50);
      --glass2: rgba(0,0,0,.28);
      --orange1:#f07a00;
      --orange2:#d35d00;
      --red:#ff2d2d;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--txt);
      background:#0b0b0b;
      overflow:hidden; /* pas de scroll */
    }

    /* Background FIXE */
    .bg{
      position:fixed; inset:0;
      background:
        linear-gradient(180deg, rgba(0,0,0,.40), rgba(0,0,0,.62)),
        url("background.png") center top/cover no-repeat;
      z-index:-2;
    }
    .bg::after{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(circle at 50% 10%, rgba(255,170,60,.18), rgba(0,0,0,.66) 62%);
      z-index:-1;
    }

    .wrap{
      height:100%;
      max-width:980px;
      margin:0 auto;
      padding:12px 14px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      position:relative;
    }

    /* ✅ UN SEUL BANDEAU (compact) */
    .band{
      flex:0 0 auto;
      border-radius:22px;
      background: linear-gradient(180deg, rgba(245,120,0,.98), rgba(210,80,0,.92));
      box-shadow: var(--shadow);
      border:1px solid rgba(255,255,255,.10);
      padding:10px 12px;
      display:grid;
      grid-template-columns: 44px 1fr 44px 92px;
      align-items:center;
      gap:10px;
    }
    .nav{
      width:44px;height:44px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      color:var(--txt);
      font-size:22px;
      font-weight:950;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
    }
    .nav:active{transform:translateY(1px)}
    .nav[disabled]{opacity:.30;cursor:default;transform:none}

    .bandTitle{
      text-align:center;
      line-height:1.1;
    }
    .bandTitle .top{
      font-weight:950;
      letter-spacing:1px;
      text-transform:uppercase;
      font-size:16px;
      opacity:.95;
    }
    .bandTitle .month{
      font-weight:950;
      font-size:30px;
      text-shadow:0 10px 22px rgba(0,0,0,.55);
    }

    .btnBack{
      justify-self:end;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      color:var(--txt);
      padding:10px 14px;
      font-weight:950;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
    }
    .btnBack:active{transform:translateY(1px)}

    /* Calendrier */
    .card{
      flex:1 1 auto;
      min-height:0;
      border-radius:22px;
      background: linear-gradient(180deg, var(--glass1), var(--glass2));
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .dow{
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:10px;
      padding:4px 6px 0;
      color:rgba(255,255,255,.72);
      font-weight:950;
      font-size:15px;
      letter-spacing:.6px;
      text-align:center;
    }

    .grid{
      flex:1 1 auto;
      min-height:0;
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:12px;
      padding:6px;
      align-content:start;
    }

    /* ✅ Cases plus grosses + style proche ton modèle */
    .day{
      height:66px;
      border-radius:18px;
      background: rgba(0,0,0,.26);
      border:1px solid rgba(255,255,255,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:22px;
      font-weight:950;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    }
    .day.empty{opacity:0;pointer-events:none}

    .day.has-event{
      border-color: rgba(255,255,255,.16);
    }

    .day.today{
      outline:4px solid var(--red);
      outline-offset:-4px;
    }

    .day.clickable{cursor:pointer}
    .day.clickable:active{transform:translateY(1px)}

    /* ✅ MINI légende (discrète, bas-gauche) */
    .legendMini{
      position:absolute;
      left:14px;
      bottom:14px;
      width:min(420px, calc(100% - 28px));
      border-radius:18px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding:10px 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px 12px;
      pointer-events:auto;
    }
    .legItem{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:950;
      font-size:16px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sq{
      width:16px;height:16px;
      border-radius:4px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.30);
      flex:0 0 auto;
    }

    /* Modal demi page */
    .overlay{
      position:fixed; inset:0;
      display:none;
      background: rgba(0,0,0,.62);
      z-index:50;
      padding:14px;
    }
    .overlay.open{display:block}
    .modal{
      max-width:980px;
      margin:0 auto;
      height:52vh;
      border-radius:22px;
      background: linear-gradient(180deg, rgba(0,0,0,.72), rgba(0,0,0,.45));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display:flex;
      flex-direction:column;
    }
    .modalHead{
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      font-weight:950;
    }
    .close{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      color:var(--txt);
      padding:10px 14px;
      border-radius:16px;
      font-weight:950;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
    }
    .close:active{transform:translateY(1px)}
    .modalBody{
      padding:14px;
      overflow:auto;
      font-size:16px;
      line-height:1.35;
      color:rgba(255,255,255,.92);
    }
    .muted{color:rgba(255,255,255,.70);font-style:italic}

    @media (max-width:380px){
      .day{height:60px;font-size:20px}
      .bandTitle .month{font-size:26px}
      .legendMini{padding:9px}
      .legItem{font-size:15px}
    }
  </style>
</head>

<body>
  <div class="bg"></div>

  <div class="wrap">
    <div class="band">
      <button class="nav" id="btnPrev" aria-label="Mois précédent">‹</button>

      <div class="bandTitle">
        <div class="top">PLANNING 2026</div>
        <div class="month" id="monthTitle">—</div>
      </div>

      <button class="nav" id="btnNext" aria-label="Mois suivant">›</button>

      <button class="btnBack" id="btnBack">Retour</button>
    </div>

    <section class="card">
      <div class="dow">
        <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
      </div>
      <div class="grid" id="grid"></div>
    </section>

    <!-- ✅ Légende mini -->
    <div class="legendMini" id="legendMini"></div>
  </div>

  <!-- Modal note -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <div id="modalTitle">—</div>
        <button class="close" id="btnClose">Fermer</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

<script>
  const API = "https://script.google.com/macros/s/AKfycbzPHCDdW7wkFCVkMOL_2srZmdnjZ1QKmToUFtqIZBPjSUNtOwM-Ac7ua0w9dhCv3oI/exec";
  const BACK_URL = "index.html";
  const YEAR = 2026;

  const MONTHS = ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];

  const $grid = document.getElementById("grid");
  const $monthTitle = document.getElementById("monthTitle");
  const $legendMini = document.getElementById("legendMini");
  const $btnPrev = document.getElementById("btnPrev");
  const $btnNext = document.getElementById("btnNext");

  const $overlay = document.getElementById("overlay");
  const $modalTitle = document.getElementById("modalTitle");
  const $modalBody = document.getElementById("modalBody");

  document.getElementById("btnBack").addEventListener("click", ()=>location.href=BACK_URL);
  document.getElementById("btnClose").addEventListener("click", closeModal);
  $overlay.addEventListener("click", (e)=>{ if(e.target === $overlay) closeModal(); });

  function jsonp(url, cbName){
    return new Promise((resolve, reject) => {
      const s = document.createElement("script");
      const cleanup = () => { s.remove(); try{ delete window[cbName]; }catch(e){ window[cbName]=undefined; } };
      const t = setTimeout(()=>{ cleanup(); reject(new Error("Timeout JSONP")); }, 12000);
      window[cbName] = (data)=>{ clearTimeout(t); cleanup(); resolve(data); };
      s.src = url;
      s.onerror = ()=>{ clearTimeout(t); cleanup(); reject(new Error("Erreur JSONP")); };
      document.head.appendChild(s);
    });
  }
  function esc(x){
    return (x==null?"":String(x))
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function normCat(s){ return String(s||"").trim().toLowerCase(); }
  function dateKey(y,m,d){
    return `${y}-${String(m+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
  }

  function openModal(title, html){
    $modalTitle.textContent = title;
    $modalBody.innerHTML = html;
    $overlay.classList.add("open");
    $overlay.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    $overlay.classList.remove("open");
    $overlay.setAttribute("aria-hidden","true");
  }

  // Cache local (évite reload pénible)
  const CACHE_KEY = "cs_planning_cache_compact_" + YEAR;
  const CACHE_TTL = 12 * 60 * 60 * 1000;

  let EVENTS = [];
  let CATCOLORS = {};
  let CATS = []; // [{category,color,order}]
  let currentMonth = (new Date().getFullYear() === YEAR) ? new Date().getMonth() : 0;

  function setNavDisabled(){
    $btnPrev.disabled = (currentMonth === 0);
    $btnNext.disabled = (currentMonth === 11);
  }

  function buildLegend(){
    $legendMini.innerHTML = "";
    const list = (CATS.length ? CATS : Object.keys(CATCOLORS).map(c=>({category:c,color:CATCOLORS[c],order:9999})))
      .slice()
      .sort((a,b)=>(a.order-b.order)||a.category.localeCompare(b.category));

    for(const it of list){
      const div = document.createElement("div");
      div.className = "legItem";
      div.innerHTML = `<span class="sq" style="background:${esc(it.color||"rgba(255,255,255,.30)")};"></span><span>${esc(it.category)}</span>`;
      $legendMini.appendChild(div);
    }
  }

  function buildMonth(){
    $grid.innerHTML = "";
    $monthTitle.textContent = MONTHS[currentMonth];
    setNavDisabled();

    const first = new Date(YEAR, currentMonth, 1);
    const jsDay = first.getDay(); // 0=dim
    const offset = (jsDay===0)?6:(jsDay-1);
    const daysInMonth = new Date(YEAR, currentMonth+1, 0).getDate();

    const byDate = new Map();
    for(const ev of EVENTS){
      if(!ev.date) continue;
      if(!byDate.has(ev.date)) byDate.set(ev.date, []);
      byDate.get(ev.date).push(ev);
    }

    for(let i=0;i<offset;i++){
      const c = document.createElement("div");
      c.className = "day empty";
      $grid.appendChild(c);
    }

    const now = new Date();
    const todayKey = (now.getFullYear()===YEAR) ? dateKey(YEAR, now.getMonth(), now.getDate()) : "";

    for(let d=1; d<=daysInMonth; d++){
      const key = dateKey(YEAR, currentMonth, d);
      const cell = document.createElement("div");
      cell.className = "day";
      cell.textContent = d;

      if(key === todayKey) cell.classList.add("today");

      const list = byDate.get(key) || [];
      if(list.length){
        const cat = normCat(list[0].category);
        const col = CATCOLORS[cat] || "rgba(255,255,255,.22)";
        cell.classList.add("has-event");
        cell.style.background = `linear-gradient(180deg, ${col}, rgba(0,0,0,.26))`;

        const withNote = list.find(x => String(x.details||"").trim() !== "");
        if(withNote){
          cell.classList.add("clickable");
          cell.addEventListener("click", ()=>{
            const title = `${d} ${MONTHS[currentMonth]} ${YEAR}`;
            const html = list.map(ev=>{
              const h = [ev.start, ev.end].filter(Boolean).join(" - ");
              const t = ev.title || "";
              const c = ev.category ? ` <span class="muted">(${esc(ev.category)})</span>` : "";
              const det = ev.details ? `<div style="margin-top:6px;">${esc(ev.details).replaceAll("\n","<br>")}</div>` : "";
              return `<div style="padding:10px 0;border-bottom:1px solid rgba(255,255,255,.08);">
                        <div style="font-weight:950;">${esc(h ? (h+" — ") : "")}${esc(t)}${c}</div>
                        ${det}
                      </div>`;
            }).join("");
            openModal(title, html);
          });
        }
      }

      $grid.appendChild(cell);
    }
  }

  async function fetchAll(){
    const cb1 = "cb_py_" + Math.random().toString(36).slice(2);
    const cb2 = "cb_pc_" + Math.random().toString(36).slice(2);
    const urlEvents = `${API}?view=planning_year&year=${YEAR}&callback=${cb1}`;
    const urlCats = `${API}?view=planning_categories&callback=${cb2}`;

    const [py, pc] = await Promise.all([jsonp(urlEvents, cb1), jsonp(urlCats, cb2)]);
    if(!py || py.ok===false) throw new Error(py?.error || "planning_year invalide");
    if(!pc || pc.ok===false) throw new Error(pc?.error || "planning_categories invalide");

    EVENTS = Array.isArray(py.events) ? py.events : [];
    CATS = Array.isArray(pc.categories) ? pc.categories : [];

    CATCOLORS = {};
    for(const c of CATS){
      const k = normCat(c.category);
      if(!k) continue;
      CATCOLORS[k] = c.color || "rgba(255,255,255,.30)";
    }

    try{
      localStorage.setItem(CACHE_KEY, JSON.stringify({ t: Date.now(), events: EVENTS, cats: CATS }));
    }catch(e){}
  }

  function loadCache(){
    const raw = localStorage.getItem(CACHE_KEY);
    if(!raw) return false;
    try{
      const d = JSON.parse(raw);
      if(!d || !d.t) return false;
      if(Date.now()-d.t > CACHE_TTL) return false;

      EVENTS = Array.isArray(d.events) ? d.events : [];
      CATS = Array.isArray(d.cats) ? d.cats : [];
      CATCOLORS = {};
      for(const c of CATS){
        const k = normCat(c.category);
        if(!k) continue;
        CATCOLORS[k] = c.color || "rgba(255,255,255,.30)";
      }
      return true;
    }catch(e){ return false; }
  }

  $btnPrev.addEventListener("click", ()=>{
    if(currentMonth<=0) return;
    currentMonth--;
    buildMonth();
  });
  $btnNext.addEventListener("click", ()=>{
    if(currentMonth>=11) return;
    currentMonth++;
    buildMonth();
  });

  async function init(){
    const ok = loadCache();
    if(ok){
      buildLegend();
      buildMonth();
      return;
    }
    // rendu rapide puis fetch
    buildLegend();
    buildMonth();
    try{
      await fetchAll();
      buildLegend();
      buildMonth();
    }catch(err){ console.error(err); }
  }

  init();
</script>
</body>
</html>
