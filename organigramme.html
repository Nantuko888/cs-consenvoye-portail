<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Organigramme - CS Consenvoye</title>

<style>
  :root{
    --maxw: 1100px;
    --pad: clamp(12px, 4vw, 20px);
    --gap: clamp(10px, 2.6vw, 16px);

    --glass: rgba(0,0,0,.42);
    --stroke: rgba(255,170,70,.28);

    --txt: rgba(255,255,255,.95);
    --muted: rgba(255,255,255,.72);

    --radius: 18px;
    --shadow: 0 16px 44px rgba(0,0,0,.35);

    /* TAILLES (COMPACTES) */
    --dirRole: 11px;
    --chefName: 16px;
    --adjName: 14px;
    --poleFont: 12px;
    --poleMinH: 68px;
  }

  *{box-sizing:border-box}
  html, body{
    margin:0; padding:0; min-height:100%;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color: var(--txt);
    background:#000;
  }

  /* Background FIXE */
  body::before{
    content:"";
    position:fixed; inset:0;
    background:url("background.png") center top / cover no-repeat;
    transform: translateZ(0);
    z-index:0;
  }

  .wrap{
    position:relative; z-index:1;
    max-width: var(--maxw);
    margin: 0 auto;
    padding: calc(env(safe-area-inset-top) + var(--pad)) var(--pad) calc(env(safe-area-inset-bottom) + var(--pad));
  }

  .topbar{
    display:flex; align-items:center; justify-content:space-between;
    gap: 10px;
    margin-bottom: 10px;
  }

  .btn{
    appearance:none;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.35);
    color: var(--txt);
    padding: 9px 12px;
    border-radius: 14px;
    font-weight: 950;
    cursor:pointer;
    box-shadow: 0 10px 24px rgba(0,0,0,.25);
    backdrop-filter: blur(8px);
    -webkit-tap-highlight-color: transparent;
  }
  .btn:active{ transform: translateY(1px); }
  .btn.primary{
    border-color: var(--stroke);
    background: linear-gradient(180deg, rgba(255,170,70,.16), rgba(0,0,0,.35));
  }

  .title{
    font-size: clamp(22px, 4.2vw, 34px);
    font-weight: 1000;
    margin: 6px 0 12px;
    text-shadow: 0 12px 26px rgba(0,0,0,.55);
    letter-spacing: .2px;
  }

  .card{
    background: var(--glass);
    border: 1px solid var(--stroke);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    backdrop-filter: blur(10px);
    overflow:hidden;
  }

  /* Direction (COMPACT) */
  .dir{
    padding: 12px;
    display:grid;
    gap: 10px;
  }

  .chef{
    border-radius: 16px;
    padding: 10px 10px;
    text-align:center;
    background: linear-gradient(180deg, rgba(255,220,110,.95), rgba(255,165,55,.88));
    color:#111;
    box-shadow: 0 12px 26px rgba(0,0,0,.22);
  }
  .chef .role{
    font-size: var(--dirRole);
    font-weight: 1000;
    text-transform: uppercase;
    letter-spacing: .6px;
    opacity:.92;
  }
  .chef .name{
    font-size: var(--chefName);
    font-weight: 1000;
    margin-top: 4px;
    word-break: break-word;
  }

  .adjs{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .adj{
    border-radius: 16px;
    padding: 9px 10px;
    text-align:center;
    background: linear-gradient(180deg, rgba(255,135,55,.90), rgba(255,105,20,.78));
    border:1px solid rgba(255,255,255,.10);
    box-shadow: 0 12px 26px rgba(0,0,0,.20);
  }
  .adj .role{
    font-size: var(--dirRole);
    font-weight: 1000;
    text-transform: uppercase;
    letter-spacing: .55px;
    opacity:.95;
  }
  .adj .name{
    font-size: var(--adjName);
    font-weight: 950;
    margin-top: 4px;
    word-break: break-word;
  }

  /* Pôles */
  .polesWrap{ margin-top: var(--gap); }
  .polesHead{
    margin: 0 0 10px;
    font-weight: 1000;
    text-transform: uppercase;
    letter-spacing: .65px;
    color: rgba(255,210,140,.95);
    text-shadow: 0 10px 18px rgba(0,0,0,.4);
  }

  .poles{
    display:grid;
    grid-template-columns: repeat(2, minmax(0,1fr));
    gap: 10px;
  }
  @media (min-width: 520px){
    .poles{ grid-template-columns: repeat(3, minmax(0,1fr)); }
  }
  @media (min-width: 900px){
    .poles{ grid-template-columns: repeat(4, minmax(0,1fr)); }
  }

  .poleBtn{
    border:none;
    padding:0;
    background: transparent;
    cursor:pointer;
    -webkit-tap-highlight-color: transparent;
  }

  .poleTile{
    border-radius: 16px;
    min-height: var(--poleMinH);
    padding: 10px 10px;
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    font-weight: 1000;
    text-transform: uppercase;
    letter-spacing: .35px;
    font-size: var(--poleFont);
    color:#0f0f0f;
    box-shadow: 0 16px 34px rgba(0,0,0,.22);
    border: 1px solid rgba(255,255,255,.14);
    position:relative;
    overflow:hidden;
  }
  .poleTile::after{
    content:"";
    position:absolute; inset:0;
    background:
      radial-gradient(circle at 18% 15%, rgba(255,255,255,.18), transparent 55%),
      radial-gradient(circle at 92% 115%, rgba(0,0,0,.14), transparent 55%);
    pointer-events:none;
  }
  .poleTile span{ position:relative; z-index:1; line-height:1.1; }

  /* Modal plein écran */
  .modal{
    position: fixed;
    inset: 0;
    z-index: 50;
    display:none;
  }
  .modal.open{ display:block; }

  .modalBg{
    position:absolute; inset:0;
    background: rgba(0,0,0,.66);
    backdrop-filter: blur(6px);
  }

  .modalBox{
    position:absolute;
    left: 50%;
    transform: translateX(-50%);
    top: calc(env(safe-area-inset-top) + 12px);
    width: min(94vw, 920px);
    max-height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 24px);
    overflow:auto;

    background: rgba(0,0,0,.60);
    border: 1px solid var(--stroke);
    border-radius: 18px;
    box-shadow: 0 22px 70px rgba(0,0,0,.45);
  }

  .modalHead{
    position: sticky;
    top: 0;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
    padding: 10px 12px;
    background: rgba(0,0,0,.78);
    border-bottom: 1px solid rgba(255,255,255,.10);
    backdrop-filter: blur(10px);
  }

  .modalTitle{
    font-weight:1000;
    text-transform: uppercase;
    letter-spacing: .55px;
    color: rgba(255,210,140,.95);
  }

  .modalBody{
    padding: 12px 12px 14px;
    display:grid;
    gap: 12px;
  }

  .subCard{
    border:1px solid rgba(255,255,255,.12);
    border-radius: 16px;
    overflow:hidden;
    background: rgba(0,0,0,.25);
  }
  .subHead{
    padding: 9px 10px;
    font-weight: 1000;
    text-transform: uppercase;
    letter-spacing: .3px;
    background: rgba(255,255,255,.08);
  }
  .people{
    padding: 10px 10px;
    display:grid;
    gap: 8px;
  }

  .person{
    padding: 9px 9px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.22);
    display:grid;
    grid-template-columns: 200px 1fr;
    gap: 10px;
    align-items:start;
  }
  .fn{
    font-weight: 1000;
    color: rgba(255,200,120,.98);
  }
  .nm{
    font-weight: 900;
    opacity: .95;
    word-break: break-word;
  }
  @media (max-width: 420px){
    .person{ grid-template-columns: 1fr; }
  }

  .empty{
    padding: 14px;
    border-radius: 16px;
    border: 1px dashed rgba(255,255,255,.18);
    background: rgba(0,0,0,.18);
    text-align:center;
    font-weight: 900;
    color: var(--muted);
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <button class="btn" id="backBtn">Retour</button>
    <button class="btn primary" id="reloadBtn">Actualiser</button>
  </div>

  <div class="title">Organigramme</div>

  <section class="card">
    <div class="dir">
      <div class="chef">
        <div class="role">Chef de centre</div>
        <div class="name" id="chefName">—</div>
      </div>
      <div class="adjs">
        <div class="adj">
          <div class="role">1er adjoint</div>
          <div class="name" id="adj1Name">—</div>
        </div>
        <div class="adj">
          <div class="role">2ème adjoint</div>
          <div class="name" id="adj2Name">—</div>
        </div>
      </div>
    </div>
  </section>

  <section class="polesWrap">
    <div class="polesHead">Pôles</div>
    <div class="poles" id="poles"></div>
  </section>
</div>

<div class="modal" id="modal">
  <div class="modalBg" id="modalBg"></div>
  <div class="modalBox">
    <div class="modalHead">
      <div class="modalTitle" id="modalTitle">Pôle</div>
      <button class="btn" id="closeBtn">Fermer</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
  </div>
</div>

<script>
  const API = "https://script.google.com/macros/s/AKfycbzPHCDdW7wkFCVkMOL_2srZmdnjZ1QKmToUFtqIZBPjSUNtOwM-Ac7ua0w9dhCv3oI/exec";

  // ✅ Palette vraiment distincte (pas 3 couleurs proches)
  const PALETTE = [
    "#4CC9F0", // bleu
    "#F9C74F", // jaune
    "#90BE6D", // vert
    "#F8961E", // orange
    "#F28482", // rose
    "#9D4EDD", // violet
    "#43AA8B", // turquoise
    "#577590" // bleu-gris
  ];

  // ✅ Fallback avec TES pôles (inclut JSP / Amicale / Équipe de soutien)
  const FALLBACK = {
    direction: { chef:"À renseigner", adj1:"À renseigner", adj2:"À renseigner" },
    poles: [
      { id:"ope", libelle:"Opérationnel", sousPoles:[] },
      { id:"jsp", libelle:"JSP", sousPoles:[] },
      { id:"tech", libelle:"Technique", sousPoles:[] },
      { id:"adm", libelle:"Administratif", sousPoles:[] },
      { id:"ami", libelle:"Amicale", sousPoles:[] },
      { id:"soutien", libelle:"Équipe de soutien", sousPoles:[] },
      { id:"formation", libelle:"Formation", sousPoles:[] }
    ]
  };

  const $chef = document.getElementById("chefName");
  const $adj1 = document.getElementById("adj1Name");
  const $adj2 = document.getElementById("adj2Name");
  const $poles = document.getElementById("poles");

  const $modal = document.getElementById("modal");
  const $modalTitle = document.getElementById("modalTitle");
  const $modalBody = document.getElementById("modalBody");
  const $closeBtn = document.getElementById("closeBtn");
  const $modalBg = document.getElementById("modalBg");

  document.getElementById("backBtn").onclick = () => location.href = "index.html";
  document.getElementById("reloadBtn").onclick = () => load();
  $closeBtn.onclick = closeModal;
  $modalBg.onclick = closeModal;

  function closeModal(){ $modal.classList.remove("open"); }

  function jsonp(url){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const s = document.createElement("script");
      const sep = url.includes("?") ? "&" : "?";
      s.src = url + sep + "view=org&callback=" + cb + "&_=" + Date.now();
      window[cb] = (data)=>{ delete window[cb]; s.remove(); resolve(data); };
      s.onerror = ()=>{ delete window[cb]; s.remove(); reject(new Error("JSONP fail")); };
      document.head.appendChild(s);
    });
  }

  function setDirection(dir){
    $chef.textContent = dir?.chef || "—";
    $adj1.textContent = dir?.adj1 || "—";
    $adj2.textContent = dir?.adj2 || "—";
  }

  // Couleur stable par nom (même pôle = même couleur)
  function colorForPoleName(name){
    const key = String(name || "").toLowerCase().trim();
    let h = 0;
    for (let i=0;i<key.length;i++) h = (h*31 + key.charCodeAt(i)) >>> 0;
    return PALETTE[h % PALETTE.length];
  }

  function renderPoles(poles){
    $poles.innerHTML = "";
    poles.forEach((p, i)=>{
      const btn = document.createElement("button");
      btn.className = "poleBtn";
      btn.type = "button";

      const tile = document.createElement("div");
      tile.className = "poleTile";

      // Si Apps Script envoie une couleur, on la respecte, sinon couleur stable par libellé
      const c = p.couleur || colorForPoleName(p.libelle);
      tile.style.background = `linear-gradient(180deg, ${c}EE, ${c}B5)`;

      const sp = document.createElement("span");
      sp.textContent = p.libelle || "Pôle";
      tile.appendChild(sp);
      btn.appendChild(tile);

      btn.onclick = ()=> openPole(p);
      $poles.appendChild(btn);
    });
  }

  function openPole(p){
    $modalTitle.textContent = p.libelle || "Pôle";
    $modalBody.innerHTML = "";

    const subs = p.sousPoles || [];
    if(!subs.length){
      $modalBody.innerHTML = `<div class="empty">Aucun contenu pour ce pôle (pour l’instant).</div>`;
      $modal.classList.add("open");
      return;
    }

    subs.forEach(sp=>{
      const sc = document.createElement("div");
      sc.className = "subCard";

      const head = document.createElement("div");
      head.className = "subHead";
      head.textContent = sp.libelle || "Sous-pôle";
      sc.appendChild(head);

      const list = document.createElement("div");
      list.className = "people";

      const mem = sp.membres || [];
      if(!mem.length){
        const e = document.createElement("div");
        e.className = "empty";
        e.textContent = "Aucun membre.";
        list.appendChild(e);
      }else{
        mem.forEach(m=>{
          const row = document.createElement("div");
          row.className = "person";

          const fn = document.createElement("div");
          fn.className = "fn";
          fn.textContent = m.fonction || "";

          const nm = document.createElement("div");
          nm.className = "nm";
          nm.textContent = m.nom || "";

          row.appendChild(fn);
          row.appendChild(nm);
          list.appendChild(row);
        });
      }

      sc.appendChild(list);
      $modalBody.appendChild(sc);
    });

    $modal.classList.add("open");
  }

  async function load(){
    // 1) Toujours afficher quelque chose (propre) si API ne répond pas
    setDirection(FALLBACK.direction);
    renderPoles(FALLBACK.poles);

    // 2) Si API OK, on remplace par TES vrais pôles + TES vrais noms
    try{
      const data = await jsonp(API);
      if(data && data.ok === true){
        if(data.direction) setDirection(data.direction);
        if(Array.isArray(data.poles) && data.poles.length){
          // IMPORTANT : on respecte EXACTEMENT les libellés renvoyés
          renderPoles(data.poles);
        }
      }
    }catch(e){
      // On laisse le fallback (au moins c’est propre)
    }
  }

  load();
</script>
</body>
</html>
