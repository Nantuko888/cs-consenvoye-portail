<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Organigramme - CS Consenvoye</title>

<style>
  :root{
    --maxw: 1100px;
    --pad: clamp(12px, 4vw, 22px);
    --gap: clamp(10px, 2.6vw, 16px);

    --glass: rgba(0,0,0,.45);
    --stroke: rgba(255,170,70,.30);

    --txt: rgba(255,255,255,.95);
    --muted: rgba(255,255,255,.72);

    --radius: 18px;
    --shadow: 0 16px 44px rgba(0,0,0,.35);
  }

  *{box-sizing:border-box}
  html, body{
    margin:0; padding:0; min-height:100%;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color: var(--txt);
    background:#000;
  }

  /* Background FIXE (ne bouge pas) */
  body::before{
    content:"";
    position:fixed; inset:0;
    background:url("background.png") center top / cover no-repeat;
    transform: translateZ(0);
    z-index:0;
  }

  .wrap{
    position:relative; z-index:1;
    max-width: var(--maxw);
    margin: 0 auto;
    padding: calc(env(safe-area-inset-top) + var(--pad)) var(--pad) calc(env(safe-area-inset-bottom) + var(--pad));
  }

  /* Top bar */
  .topbar{
    display:flex; align-items:center; justify-content:space-between;
    gap: 10px;
    margin-bottom: 12px;
  }

  .btn{
    appearance:none;
    border:1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.35);
    color: var(--txt);
    padding: 10px 14px;
    border-radius: 14px;
    font-weight: 900;
    cursor:pointer;
    box-shadow: 0 12px 26px rgba(0,0,0,.25);
    backdrop-filter: blur(8px);
    -webkit-tap-highlight-color: transparent;
  }
  .btn:active{ transform: translateY(1px); }
  .btn.primary{
    border-color: var(--stroke);
    background: linear-gradient(180deg, rgba(255,170,70,.18), rgba(0,0,0,.35));
  }

  /* Title */
  .title{
    font-size: clamp(26px, 4.6vw, 44px);
    font-weight: 1000;
    margin: 6px 0 14px;
    text-shadow: 0 12px 26px rgba(0,0,0,.55);
    letter-spacing: .3px;
  }

  /* Cards */
  .card{
    background: var(--glass);
    border: 1px solid var(--stroke);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    backdrop-filter: blur(10px);
    overflow:hidden;
  }

  /* Direction layout */
  .dir{
    padding: 14px;
    display:grid;
    gap: 12px;
  }

  .chef{
    border-radius: 18px;
    padding: 14px 12px;
    text-align:center;
    background: linear-gradient(180deg, rgba(255,220,110,.98), rgba(255,160,45,.92));
    color:#111;
    box-shadow: 0 14px 30px rgba(0,0,0,.25);
  }
  .chef .role{
    font-size: 12px;
    font-weight: 1000;
    text-transform: uppercase;
    letter-spacing: .7px;
    opacity:.92;
  }
  .chef .name{
    font-size: 20px;
    font-weight: 1000;
    margin-top: 6px;
    word-break: break-word;
  }

  .adjs{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .adj{
    border-radius: 18px;
    padding: 12px 10px;
    text-align:center;
    background: linear-gradient(180deg, rgba(255,140,60,.92), rgba(255,105,20,.82));
    border:1px solid rgba(255,255,255,.12);
    box-shadow: 0 14px 30px rgba(0,0,0,.22);
  }
  .adj .role{
    font-size: 12px;
    font-weight: 1000;
    text-transform: uppercase;
    letter-spacing: .6px;
    opacity:.95;
  }
  .adj .name{
    font-size: 16px;
    font-weight: 950;
    margin-top: 6px;
    word-break: break-word;
  }

  /* Poles grid */
  .polesWrap{ margin-top: var(--gap); }

  .polesHead{
    margin: 0 0 10px;
    font-weight: 1000;
    text-transform: uppercase;
    letter-spacing: .7px;
    color: rgba(255,210,140,.95);
    text-shadow: 0 10px 18px rgba(0,0,0,.4);
  }

  .poles{
    display:grid;
    grid-template-columns: repeat(2, minmax(0,1fr));
    gap: 12px;
  }
  @media (min-width: 520px){
    .poles{ grid-template-columns: repeat(3, minmax(0,1fr)); }
  }
  @media (min-width: 900px){
    .poles{ grid-template-columns: repeat(4, minmax(0,1fr)); }
  }

  .poleBtn{
    border:none;
    padding:0;
    background: transparent;
    cursor:pointer;
    -webkit-tap-highlight-color: transparent;
  }

  .poleTile{
    border-radius: 18px;
    min-height: 84px;
    padding: 12px 10px;
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    font-weight: 1000;
    text-transform: uppercase;
    letter-spacing: .4px;
    color:#101010;
    box-shadow: 0 18px 40px rgba(0,0,0,.25);
    border: 1px solid rgba(255,255,255,.16);
    position:relative;
    overflow:hidden;
  }
  .poleTile::after{
    content:"";
    position:absolute; inset:0;
    background:
      radial-gradient(circle at 15% 15%, rgba(255,255,255,.20), transparent 55%),
      radial-gradient(circle at 90% 110%, rgba(0,0,0,.14), transparent 55%);
    pointer-events:none;
  }
  .poleTile span{ position:relative; z-index:1; line-height:1.15; }

  /* Modal full screen */
  .modal{
    position: fixed;
    inset: 0;
    z-index: 50;
    display:none;
  }
  .modal.open{ display:block; }

  .modalBg{
    position:absolute; inset:0;
    background: rgba(0,0,0,.65);
    backdrop-filter: blur(6px);
  }

  .modalBox{
    position:absolute;
    left: 50%;
    transform: translateX(-50%);
    top: calc(env(safe-area-inset-top) + 14px);
    width: min(94vw, 920px);
    max-height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 28px);
    overflow:auto;

    background: rgba(0,0,0,.60);
    border: 1px solid var(--stroke);
    border-radius: 20px;
    box-shadow: 0 22px 70px rgba(0,0,0,.45);
  }

  .modalHead{
    position: sticky;
    top: 0;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
    padding: 12px 14px;
    background: rgba(0,0,0,.75);
    border-bottom: 1px solid rgba(255,255,255,.10);
    backdrop-filter: blur(10px);
  }

  .modalTitle{
    font-weight:1000;
    text-transform: uppercase;
    letter-spacing: .6px;
    color: rgba(255,210,140,.95);
  }

  .modalBody{
    padding: 12px 14px 16px;
    display:grid;
    gap: 12px;
  }

  .subCard{
    border:1px solid rgba(255,255,255,.12);
    border-radius: 16px;
    overflow:hidden;
    background: rgba(0,0,0,.25);
  }
  .subHead{
    padding: 10px 12px;
    font-weight: 1000;
    text-transform: uppercase;
    letter-spacing: .35px;
    background: rgba(255,255,255,.08);
  }
  .people{
    padding: 10px 12px;
    display:grid;
    gap: 8px;
  }

  /* aligné propre : Fonction | Nom */
  .person{
    padding: 10px 10px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.22);
    display:grid;
    grid-template-columns: 210px 1fr;
    gap: 10px;
    align-items:start;
  }
  .fn{
    font-weight: 1000;
    color: rgba(255,200,120,.98);
  }
  .nm{
    font-weight: 900;
    opacity: .95;
    word-break: break-word;
  }
  @media (max-width: 420px){
    .person{ grid-template-columns: 1fr; }
  }

  .empty{
    padding: 14px;
    border-radius: 16px;
    border: 1px dashed rgba(255,255,255,.18);
    background: rgba(0,0,0,.18);
    text-align:center;
    font-weight: 900;
    color: var(--muted);
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <button class="btn" id="backBtn">Retour</button>
    <button class="btn primary" id="reloadBtn">Actualiser</button>
  </div>

  <div class="title">Organigramme</div>

  <!-- Direction -->
  <section class="card">
    <div class="dir">
      <div class="chef">
        <div class="role">Chef de centre</div>
        <div class="name" id="chefName">—</div>
      </div>
      <div class="adjs">
        <div class="adj">
          <div class="role">1er adjoint</div>
          <div class="name" id="adj1Name">—</div>
        </div>
        <div class="adj">
          <div class="role">2ème adjoint</div>
          <div class="name" id="adj2Name">—</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Poles -->
  <section class="polesWrap">
    <div class="polesHead">Pôles</div>
    <div class="poles" id="poles"></div>
  </section>
</div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="modalBg" id="modalBg"></div>
  <div class="modalBox">
    <div class="modalHead">
      <div class="modalTitle" id="modalTitle">Pôle</div>
      <button class="btn" id="closeBtn">Fermer</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
  </div>
</div>

<script>
  // ✅ URL APPS SCRIPT (la tienne)
  const API = "https://script.google.com/macros/s/AKfycbzPHCDdW7wkFCVkMOL_2srZmdnjZ1QKmToUFtqIZBPjSUNtOwM-Ac7ua0w9dhCv3oI/exec";

  // ✅ Données de secours (rempli) si Sheets / API ne renvoie rien
  const FALLBACK = {
    direction: { chef: "À renseigner", adj1: "À renseigner", adj2: "À renseigner" },
    poles: [
      { id:"direction", libelle:"Direction", couleur:"#ffd166", sousPoles:[
        { id:"cdc", libelle:"Bureau", membres:[ {fonction:"Chef de centre", nom:"Nom Prénom"} ] }
      ]},
      { id:"ope", libelle:"Opérationnel", couleur:"#7bd3ff", sousPoles:[
        { id:"vsav", libelle:"VSAV", membres:[ {fonction:"Responsable", nom:"Nom Prénom"}, {fonction:"Adjoint", nom:"Nom Prénom"} ] },
        { id:"inc", libelle:"Incendie", membres:[ {fonction:"Référent", nom:"Nom Prénom"} ] }
      ]},
      { id:"jsp", libelle:"JSP", couleur:"#95d5b2", sousPoles:[
        { id:"enc", libelle:"Encadrement", membres:[ {fonction:"Responsable", nom:"Nom Prénom"} ] }
      ]},
      { id:"ami", libelle:"Amicale", couleur:"#cdb4ff", sousPoles:[
        { id:"bur", libelle:"Bureau", membres:[ {fonction:"Président", nom:"Nom Prénom"} ] }
      ]},
      { id:"soutien", libelle:"Équipe de soutien", couleur:"#f7b267", sousPoles:[
        { id:"log", libelle:"Logistique", membres:[ {fonction:"Référent", nom:"Nom Prénom"} ] }
      ]},
      { id:"tech", libelle:"Technique", couleur:"#f28482", sousPoles:[
        { id:"mat", libelle:"Matériel", membres:[ {fonction:"Référent", nom:"Nom Prénom"} ] }
      ]},
    ]
  };

  const $chef = document.getElementById("chefName");
  const $adj1 = document.getElementById("adj1Name");
  const $adj2 = document.getElementById("adj2Name");
  const $poles = document.getElementById("poles");

  const $modal = document.getElementById("modal");
  const $modalTitle = document.getElementById("modalTitle");
  const $modalBody = document.getElementById("modalBody");
  const $closeBtn = document.getElementById("closeBtn");
  const $modalBg = document.getElementById("modalBg");

  document.getElementById("backBtn").onclick = () => location.href = "index.html";
  document.getElementById("reloadBtn").onclick = () => load();
  $closeBtn.onclick = closeModal;
  $modalBg.onclick = closeModal;

  function closeModal(){
    $modal.classList.remove("open");
  }

  function jsonp(url){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const s = document.createElement("script");
      const sep = url.includes("?") ? "&" : "?";
      s.src = url + sep + "view=org&callback=" + cb + "&_=" + Date.now();
      window[cb] = (data)=>{
        delete window[cb];
        s.remove();
        resolve(data);
      };
      s.onerror = ()=>{
        delete window[cb];
        s.remove();
        reject(new Error("JSONP fail"));
      };
      document.head.appendChild(s);
    });
  }

  function setDirection(dir){
    $chef.textContent = (dir && dir.chef) ? dir.chef : "—";
    $adj1.textContent = (dir && dir.adj1) ? dir.adj1 : "—";
    $adj2.textContent = (dir && dir.adj2) ? dir.adj2 : "—";
  }

  function renderPoles(poles){
    $poles.innerHTML = "";
    poles.forEach((p, i)=>{
      const btn = document.createElement("button");
      btn.className = "poleBtn";
      btn.type = "button";

      const tile = document.createElement("div");
      tile.className = "poleTile";

      const c = p.couleur || ["#7bd3ff","#ffd166","#cdb4ff","#95d5b2","#f28482","#f7b267"][i%6];
      tile.style.background = `linear-gradient(180deg, ${c}EE, ${c}B5)`;

      const sp = document.createElement("span");
      sp.textContent = (p.libelle || "Pôle");
      tile.appendChild(sp);
      btn.appendChild(tile);

      btn.onclick = ()=> openPole(p);
      $poles.appendChild(btn);
    });
  }

  function openPole(p){
    $modalTitle.textContent = (p.libelle || "Pôle");
    $modalBody.innerHTML = "";

    const subs = p.sousPoles || [];
    if(!subs.length){
      $modalBody.innerHTML = `<div class="empty">Aucun sous-pôle.</div>`;
      $modal.classList.add("open");
      return;
    }

    subs.forEach(sp=>{
      const sc = document.createElement("div");
      sc.className = "subCard";

      const head = document.createElement("div");
      head.className = "subHead";
      head.textContent = sp.libelle || "Sous-pôle";
      sc.appendChild(head);

      const list = document.createElement("div");
      list.className = "people";

      const mem = sp.membres || [];
      if(!mem.length){
        const e = document.createElement("div");
        e.className = "empty";
        e.textContent = "Aucun membre.";
        list.appendChild(e);
      }else{
        mem.forEach(m=>{
          const row = document.createElement("div");
          row.className = "person";

          const fn = document.createElement("div");
          fn.className = "fn";
          fn.textContent = m.fonction || "";

          const nm = document.createElement("div");
          nm.className = "nm";
          nm.textContent = m.nom || "";

          row.appendChild(fn);
          row.appendChild(nm);
          list.appendChild(row);
        });
      }

      sc.appendChild(list);
      $modalBody.appendChild(sc);
    });

    $modal.classList.add("open");
  }

  async function load(){
    // 1) affiche quelque chose de propre tout de suite
    setDirection(FALLBACK.direction);
    renderPoles(FALLBACK.poles);

    // 2) tente de charger Sheets
    try{
      const data = await jsonp(API);
      if(data && data.ok === true && Array.isArray(data.poles)){
        setDirection(data.direction || FALLBACK.direction);
        renderPoles(data.poles.length ? data.poles : FALLBACK.poles);
      }
    }catch(e){
      // laisse fallback
    }
  }

  load();
</script>
</body>
</html>
