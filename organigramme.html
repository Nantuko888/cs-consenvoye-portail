<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Organigramme - CS Consenvoye</title>

<style>
  :root{
    --maxw: 1100px;
    --pad: clamp(12px, 4vw, 20px);
    --gap: clamp(10px, 2.6vw, 16px);

    --glass: rgba(0,0,0,.45);
    --stroke: rgba(255,170,70,.26);

    --txt: rgba(255,255,255,.95);
    --muted: rgba(255,255,255,.72);

    --radius: 18px;
    --shadow: 0 16px 44px rgba(0,0,0,.35);

    /* direction compacte */
    --role: 11px;
    --nameChef: 16px;
    --nameAdj: 14px;

    /* pôles */
    --poleFont: 12px;
    --poleMinH: 70px;
  }

  *{box-sizing:border-box}
  html,body{margin:0;padding:0;min-height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--txt);background:#000;}

  body::before{
    content:"";
    position:fixed; inset:0;
    background:url("background.png") center top / cover no-repeat;
    transform:translateZ(0);
    z-index:0;
  }

  .wrap{
    position:relative; z-index:1;
    max-width:var(--maxw);
    margin:0 auto;
    padding:calc(env(safe-area-inset-top) + var(--pad)) var(--pad) calc(env(safe-area-inset-bottom) + var(--pad));
  }

  .topbar{display:flex;justify-content:space-between;gap:10px;margin-bottom:10px;}
  .btn{
    appearance:none; border:1px solid rgba(255,255,255,.14);
    background:rgba(0,0,0,.35); color:var(--txt);
    padding:9px 12px; border-radius:14px; font-weight:950; cursor:pointer;
    box-shadow:0 10px 24px rgba(0,0,0,.25); backdrop-filter:blur(8px);
    -webkit-tap-highlight-color: transparent;
  }
  .btn:active{transform:translateY(1px)}
  .btn.primary{border-color:var(--stroke); background:linear-gradient(180deg, rgba(255,170,70,.14), rgba(0,0,0,.35));}

  .title{font-size:clamp(22px,4.2vw,34px);font-weight:1000;margin:6px 0 12px;text-shadow:0 12px 26px rgba(0,0,0,.55);}

  .card{
    background:var(--glass);
    border:1px solid var(--stroke);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    backdrop-filter:blur(10px);
    overflow:hidden;
  }

  /* Direction sobre (plus orange) */
  .dir{padding:12px;display:grid;gap:10px;}
  .dirGrid{display:grid;grid-template-columns:1fr;gap:10px;}
  .chefBox,.adjBox{
    border-radius:16px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.28);
    padding:10px;
    text-align:center;
  }
  .chefBox .role,.adjBox .role{
    font-size:var(--role);
    font-weight:1000;
    text-transform:uppercase;
    letter-spacing:.55px;
    color:rgba(255,200,120,.92);
  }
  .chefBox .name{font-size:var(--nameChef);font-weight:1000;margin-top:4px;word-break:break-word;}
  .adjBox .name{font-size:var(--nameAdj);font-weight:950;margin-top:4px;word-break:break-word;}

  .adjs{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
  @media (min-width: 700px){
    .dirGrid{grid-template-columns: 1.2fr .8fr;}
    .adjs{grid-template-columns:1fr;align-content:start;}
  }

  /* Pôles */
  .polesWrap{margin-top:var(--gap);}
  .polesHead{margin:0 0 10px;font-weight:1000;text-transform:uppercase;letter-spacing:.65px;color:rgba(255,210,140,.95);text-shadow:0 10px 18px rgba(0,0,0,.4);}
  .poles{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;}
  @media (min-width:520px){.poles{grid-template-columns:repeat(3,minmax(0,1fr));}}
  @media (min-width:900px){.poles{grid-template-columns:repeat(4,minmax(0,1fr));}}

  .poleBtn{border:none;background:transparent;padding:0;cursor:pointer;-webkit-tap-highlight-color:transparent;}
  .poleTile{
    border-radius:16px; min-height:var(--poleMinH);
    padding:10px; display:flex;align-items:center;justify-content:center;text-align:center;
    font-weight:1000;text-transform:uppercase;letter-spacing:.35px;font-size:var(--poleFont);
    color:#111; border:1px solid rgba(255,255,255,.14);
    box-shadow:0 16px 34px rgba(0,0,0,.22);
    position:relative; overflow:hidden;
  }
  .poleTile::after{
    content:""; position:absolute; inset:0;
    background: radial-gradient(circle at 18% 15%, rgba(255,255,255,.18), transparent 55%),
                radial-gradient(circle at 92% 115%, rgba(0,0,0,.14), transparent 55%);
    pointer-events:none;
  }
  .poleTile span{position:relative;z-index:1;line-height:1.1}

  /* Modal */
  .modal{position:fixed;inset:0;z-index:50;display:none;}
  .modal.open{display:block;}
  .modalBg{position:absolute;inset:0;background:rgba(0,0,0,.66);backdrop-filter:blur(6px);}
  .modalBox{
    position:absolute; left:50%; transform:translateX(-50%);
    top:calc(env(safe-area-inset-top) + 12px);
    width:min(94vw, 920px);
    max-height:calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 24px);
    overflow:auto;
    background:rgba(0,0,0,.62);
    border:1px solid var(--stroke);
    border-radius:18px;
    box-shadow:0 22px 70px rgba(0,0,0,.45);
  }
  .modalHead{
    position:sticky; top:0;
    display:flex;justify-content:space-between;align-items:center;gap:10px;
    padding:10px 12px;
    background:rgba(0,0,0,.8);
    border-bottom:1px solid rgba(255,255,255,.10);
    backdrop-filter:blur(10px);
  }
  .modalTitle{font-weight:1000;text-transform:uppercase;letter-spacing:.55px;color:rgba(255,210,140,.95);}
  .modalBody{padding:12px;display:grid;gap:12px;}

  .subCard{border:1px solid rgba(255,255,255,.12);border-radius:16px;overflow:hidden;background:rgba(0,0,0,.22);}
  .subHead{padding:9px 10px;font-weight:1000;text-transform:uppercase;letter-spacing:.3px;background:rgba(255,255,255,.08);}
  .people{padding:10px;display:grid;gap:8px;}
  .person{
    padding:9px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.20);
    display:grid;grid-template-columns:200px 1fr;gap:10px;align-items:start;
  }
  .fn{font-weight:1000;color:rgba(255,200,120,.98);}
  .nm{font-weight:900;opacity:.95;word-break:break-word;}
  @media (max-width:420px){.person{grid-template-columns:1fr;}}

  .empty{
    padding:14px;border-radius:16px;border:1px dashed rgba(255,255,255,.18);
    background:rgba(0,0,0,.16);text-align:center;font-weight:900;color:var(--muted);
  }
</style>
</head>

<body>
<div class="wrap">
  <div class="topbar">
    <button class="btn" onclick="location.href='index.html'">Retour</button>
    <button class="btn primary" id="reloadBtn">Actualiser</button>
  </div>

  <div class="title">Organigramme</div>

  <section class="card">
    <div class="dir">
      <div class="dirGrid">
        <div class="chefBox">
          <div class="role">Chef de centre</div>
          <div class="name" id="chefName">—</div>
        </div>
        <div class="adjs">
          <div class="adjBox">
            <div class="role">1er adjoint</div>
            <div class="name" id="adj1Name">—</div>
          </div>
          <div class="adjBox">
            <div class="role">2ème adjoint</div>
            <div class="name" id="adj2Name">—</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="polesWrap">
    <div class="polesHead">Pôles</div>
    <div class="poles" id="poles"></div>
  </section>
</div>

<div class="modal" id="modal">
  <div class="modalBg" id="modalBg"></div>
  <div class="modalBox">
    <div class="modalHead">
      <div class="modalTitle" id="modalTitle">Pôle</div>
      <button class="btn" id="closeBtn">Fermer</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
  </div>
</div>

<script>
  // ✅ Ton URL Apps Script
  const API = "https://script.google.com/macros/s/AKfycbzPHCDdW7wkFCVkMOL_2srZmdnjZ1QKmToUFtqIZBPjSUNtOwM-Ac7ua0w9dhCv3oI/exec";

  // Couleurs DISTINCTES (stables par nom)
  const PALETTE = ["#4CC9F0","#F9C74F","#90BE6D","#F8961E","#F28482","#9D4EDD","#43AA8B","#577590"];
  function colorForName(name){
    const s = String(name||"").toLowerCase().trim();
    let h = 0; for(let i=0;i<s.length;i++) h = (h*31 + s.charCodeAt(i))>>>0;
    return PALETTE[h % PALETTE.length];
  }

  const $chef = document.getElementById("chefName");
  const $adj1 = document.getElementById("adj1Name");
  const $adj2 = document.getElementById("adj2Name");
  const $poles = document.getElementById("poles");

  const $modal = document.getElementById("modal");
  const $modalTitle = document.getElementById("modalTitle");
  const $modalBody = document.getElementById("modalBody");
  document.getElementById("closeBtn").onclick = closeModal;
  document.getElementById("modalBg").onclick = closeModal;
  document.getElementById("reloadBtn").onclick = load;

  function closeModal(){ $modal.classList.remove("open"); }

  // JSONP
  function jsonp(url){
    return new Promise((resolve, reject)=>{
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const s = document.createElement("script");
      const sep = url.includes("?") ? "&" : "?";
      s.src = url + sep + "view=org&callback=" + cb + "&_=" + Date.now();
      window[cb] = (data)=>{ delete window[cb]; s.remove(); resolve(data); };
      s.onerror = ()=>{ delete window[cb]; s.remove(); reject(new Error("JSONP fail")); };
      document.head.appendChild(s);
    });
  }

  function setDirection(dir){
    $chef.textContent = dir?.chef || "—";
    $adj1.textContent = dir?.adj1 || "—";
    $adj2.textContent = dir?.adj2 || "—";
  }

  function renderPoles(poles){
    $poles.innerHTML = "";
    if(!Array.isArray(poles) || !poles.length){
      $poles.innerHTML = `<div class="empty">Aucun pôle reçu depuis Sheets (ou Apps Script).</div>`;
      return;
    }
    poles.forEach(p=>{
      const btn = document.createElement("button");
      btn.className = "poleBtn";
      btn.type = "button";

      const tile = document.createElement("div");
      tile.className = "poleTile";

      const c = p.couleur || colorForName(p.libelle);
      tile.style.background = `linear-gradient(180deg, ${c}EE, ${c}B5)`;

      const sp = document.createElement("span");
      sp.textContent = p.libelle || "Pôle";
      tile.appendChild(sp);
      btn.appendChild(tile);

      btn.onclick = ()=> openPole(p);
      $poles.appendChild(btn);
    });
  }

  function openPole(p){
    $modalTitle.textContent = p.libelle || "Pôle";
    $modalBody.innerHTML = "";

    const subs = p.sousPoles || [];
    if(!subs.length){
      $modalBody.innerHTML = `<div class="empty">Ce pôle est vide dans Sheets (pas de sous-pôle/membre).</div>`;
      $modal.classList.add("open");
      return;
    }

    subs.forEach(sp=>{
      const sc = document.createElement("div");
      sc.className = "subCard";

      const head = document.createElement("div");
      head.className = "subHead";
      head.textContent = sp.libelle || "Sous-pôle";
      sc.appendChild(head);

      const list = document.createElement("div");
      list.className = "people";

      const mem = sp.membres || [];
      if(!mem.length){
        const e = document.createElement("div");
        e.className = "empty";
        e.textContent = "Aucun membre.";
        list.appendChild(e);
      }else{
        mem.forEach(m=>{
          const row = document.createElement("div");
          row.className = "person";

          const fn = document.createElement("div");
          fn.className = "fn";
          fn.textContent = m.fonction || "";

          const nm = document.createElement("div");
          nm.className = "nm";
          nm.textContent = m.nom || "";

          row.appendChild(fn);
          row.appendChild(nm);
          list.appendChild(row);
        });
      }

      sc.appendChild(list);
      $modalBody.appendChild(sc);
    });

    $modal.classList.add("open");
  }

  async function load(){
    try{
      const data = await jsonp(API);
      if(!data || data.ok !== true) throw new Error("Réponse invalide");
      setDirection(data.direction);
      renderPoles(data.poles);
    }catch(e){
      // si l'API ne répond pas, on affiche un message clair
      setDirection(null);
      renderPoles(null);
    }
  }

  load();
</script>
</body>
</html>
